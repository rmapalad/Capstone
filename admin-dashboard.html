<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Property Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
    <link href="css/admin-dashboard.css" rel="stylesheet">
    <link href="css/admin-dashboard-responsive.css" rel="stylesheet">
    <link href="css/account-pagination.css" rel="stylesheet">
    <link href="css/complaint-pagination.css" rel="stylesheet">
    <link href="css/booking-pagination.css" rel="stylesheet">
    <link href="css/payment-pagination.css" rel="stylesheet">
    <link href="css/enchancements.css" rel="stylesheet">
    <link href="css/listing-pagination.css" rel="stylesheet">
    <link href="css/visitor-tenant-logs-admin.css" rel="stylesheet">
    <link href="css/visitor-tenant-logs-pagination.css" rel="stylesheet">
    <link href="css/guard-mode.css" rel="stylesheet">
    <link href="css/section-persistence.css" rel="stylesheet">
    <link rel="stylesheet" href="css/complaint-analytics.css">
    <link rel="stylesheet" href="css/find-personnel-modal.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js"></script>
    
    <!-- Application Scripts -->
    <script type="text/javascript" src="js/firebase-config.js"></script>
    <script type="text/javascript" src="js/db-manager.js"></script>
    <script type="text/javascript" src="js/listing-db-global.js"></script>
    <script type="text/javascript" src="js/payment-history-db.js"></script>
    <script type="text/javascript" src="js/booking-db.js"></script>
    <script type="text/javascript" src="js/db-compatibility.js"></script>
    <script type="text/javascript" src="js/init-sync.js"></script>
    <script type="text/javascript" src="js/visitor-tenant-logs-admin.js"></script>
    <script type="text/javascript" src="js/guard-mode.js"></script>
    
    <script type="text/javascript">
        // Ensure dbManager is initialized before use
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                if (typeof dbManager === 'undefined') {
                    console.error('dbManager not found. Please check if db-manager.js is loaded correctly.');
                    return;
                }
                
                await dbManager.initialize();
                console.log('Database manager initialized successfully');
                
                // Initialize other components that depend on dbManager
                if (typeof initializeComponents === 'function') {
                    initializeComponents();
                }
                // --- Visitor Photo Cleanup on Sundays ---
                function isTodaySunday() {
                    return new Date().getDay() === 0;
                }
                function hasRunCleanupToday() {
                    const lastRun = localStorage.getItem('visitorPhotoCleanupLastRun');
                    const today = new Date().toISOString().slice(0, 10);
                    return lastRun === today;
                }
                function markCleanupRunToday() {
                    const today = new Date().toISOString().slice(0, 10);
                    localStorage.setItem('visitorPhotoCleanupLastRun', today);
                }
                async function maybeRunVisitorPhotoCleanup() {
                    if (isTodaySunday() && !hasRunCleanupToday()) {
                        if (dbManager.cleanupVisitorPhotos) {
                            await dbManager.cleanupVisitorPhotos();
                            markCleanupRunToday();
                        }
                    }
                }
                maybeRunVisitorPhotoCleanup();
                // --- End Visitor Photo Cleanup ---
            } catch (error) {
                console.error('Failed to initialize database manager:', error);
            }
        });
    </script>
    <!-- Add this in the <head> or before closing </body> if not present -->
    <script src="https://cdn.jsdelivr.net/npm/compressorjs@1.1.1/dist/compressor.min.js"></script>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header d-md-none">
            <h5 class="sidebar-title">Property Management</h5>
            <button type="button" class="btn-close" onclick="toggleSidebar()"></button>
        </div>
        <div class="sidebar-body">
        <div class="sidebar-brand">
            <i class="fas fa-building me-2"></i>
            Property Management
        </div>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a href="#" class="nav-link active" onclick="showSection('dashboard')">
                        <i class="fas fa-chart-line me-2"></i>
                        <span>Dashboard</span>
                </a>
            </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('accountManagement')">
                        <i class="fas fa-user-cog me-2"></i>
                        <span>Account Management</span>
                </a>
            </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('complaints')">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <span>Complaints</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('paymentHistory')">
                        <i class="fas fa-history me-2"></i>
                        <span>Payment History</span>
                </a>
            </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('manageListing')">
                        <i class="fas fa-list-alt me-2"></i>
                        <span>Manage Listing</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('booking')">
                        <i class="fas fa-calendar-check me-2"></i>
                        <span>Booking</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('visitorLogs')">
                        <i class="fas fa-clipboard-list me-2"></i>
                        <span>Visitor & Tenant Logs</span>
                </a>
            </li>
        </ul>
        </div>
    </div>
    <div id="sidebarOverlay" class="sidebar-overlay"></div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <nav class="navbar navbar-expand-md bg-white shadow-sm mb-4">
            <div class="container-fluid">
                <button class="navbar-toggler d-md-none" type="button" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="d-flex align-items-center">
            <div class="user-info">
                <img id="userAvatarImg" class="user-avatar" src="" alt="Profile Photo" style="width:45px;height:45px;object-fit:cover;border-radius:12px;">
                        <span id="userInfo" class="ms-2">Welcome, Admin</span>
            </div>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary d-none d-sm-inline" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                    <button class="btn btn-outline-primary d-inline d-sm-none" onclick="logout()" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
        </div>
        </nav>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="text-center d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="section">
            <div class="container-fluid">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-chart-line"></i>
                        Dashboard Overview
                    </h2>
                </div>

                <!-- Notification Area -->
                <div class="alert alert-info alert-dismissible fade show mb-4" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-bell me-3 fs-4"></i>
                        <div>
                            <strong>Notifications:</strong>
                            <ul class="mb-0 mt-2">
                                <li>3 new maintenance requests pending</li>
                                <li>2 upcoming rent payments due tomorrow</li>
                                <li>New event booking request for Conference Room</li>
                            </ul>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>

            <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-building"></i>
                        </div>
                        <div class="stat-value" id="availableApartments">0</div>
                        <div class="stat-label">Available Apartments</div>
                        <div class="stat-trend positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="apartmentTrend">Loading...</span>
                        </div>
                    </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                        <div class="stat-value" id="totalTenants">0</div>
                        <div class="stat-label">Total Tenants</div>
                        <div class="stat-trend positive">
                            <i class="fas fa-arrow-up"></i>
                            <span>8% from last month</span>
                        </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                            <i class="fas fa-calendar-check"></i>
                    </div>
                        <div class="stat-value" id="totalBookings">0</div>
                        <div class="stat-label">Event Bookings</div>
                        <div class="stat-trend positive">
                            <i class="fas fa-arrow-up"></i>
                            <span>15% from last month</span>
                        </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                            <i class="fas fa-money-bill-wave"></i>
                    </div>
                        <div class="stat-value" id="monthlyRevenue">₱0</div>
                        <div class="stat-label">Monthly Revenue</div>
                        <div class="stat-trend positive">
                            <i class="fas fa-arrow-up"></i>
                            <span>15% from last month</span>
                        </div>
                </div>
            </div>

                <div class="row mb-4">
                    <!-- Latest Payments -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-white">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-money-bill-wave me-2"></i>
                                    Latest Payments
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Tenant</th>
                                                <th>Amount</th>
                                                <th>Date</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="latestPaymentsList">
                                            <!-- Payments will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Upcoming Events -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-white">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-calendar-alt me-2"></i>
                                    Upcoming Events
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Event</th>
                                                <th>Date</th>
                                                <th>Location</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="upcomingEventsList">
                                            <!-- Events will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                </div>
            </div>

                <div class="dashboard-charts">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Revenue Overview</h3>
                            <div class="chart-actions">
                                <button title="Refresh" class="btn btn-link">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <canvas id="revenueChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Property Status</h3>
                            <div class="chart-actions">
                                <button title="Refresh" class="btn btn-link">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <canvas id="propertyStatusChart"></canvas>
                    </div>
                </div>

                <div class="recent-activity">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i class="fas fa-history"></i>
                            Recent Activity
                        </h3>
                    </div>
                    <ul class="activity-list">
                        <li class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-user-plus"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">New tenant registered</div>
                                <div class="activity-time">2 hours ago</div>
                            </div>
                        </li>
                        <li class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-tools"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">Maintenance request completed</div>
                                <div class="activity-time">5 hours ago</div>
                            </div>
                        </li>
                        <li class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">Payment received</div>
                                <div class="activity-time">1 day ago</div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Properties Section -->
        <div id="propertiesSection" class="section" style="display: none;">
            <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-home me-2"></i>Properties</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPropertyModal">
                        <i class="fas fa-plus"></i> Add Property
                </button>
            </div>

                <div class="row g-3 mb-4">
                    <div class="col-12 col-md-4">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-building"></i>
                    </div>
                    <div class="stat-value" id="totalProperties">0</div>
                    <div class="stat-label">Total Properties</div>
                </div>
                    </div>
                    <div class="col-12 col-md-4">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-key"></i>
                    </div>
                    <div class="stat-value" id="availableProperties">0</div>
                    <div class="stat-label">Available Properties</div>
                </div>
                    </div>
                    <div class="col-12 col-md-4">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-user-home"></i>
                    </div>
                    <div class="stat-value" id="occupiedProperties">0</div>
                    <div class="stat-label">Occupied Properties</div>
                        </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                            <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Tenant</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="propertiesList">
                                <!-- Properties will be loaded here -->
                            </tbody>
                        </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tenants Section -->
        <div id="tenantsSection" class="section" style="display: none;">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-users me-2"></i>Tenants</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTenantModal">
                        <i class="fas fa-plus"></i> Add Tenant
                    </button>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-12 col-md-4">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-value" id="totalTenants">0</div>
                            <div class="stat-label">Total Tenants</div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-user-check"></i>
                            </div>
                            <div class="stat-value" id="activeTenants">0</div>
                            <div class="stat-label">Active Tenants</div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-user-clock"></i>
                            </div>
                            <div class="stat-value" id="pendingTenants">0</div>
                            <div class="stat-label">Pending Tenants</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Property</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="tenantsList">
                                    <!-- Tenants will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Maintenance Section -->
        <div id="maintenanceSection" class="section" style="display: none;">
            <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-tools me-2"></i>Maintenance Requests</h2>
            </div>

                <div class="row g-3 mb-4">
                    <div class="col-12 col-md-4">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div class="stat-value" id="totalRequests">0</div>
                    <div class="stat-label">Total Requests</div>
                </div>
                    </div>
                    <div class="col-12 col-md-4">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-value" id="pendingRequests">0</div>
                    <div class="stat-label">Pending Requests</div>
                </div>
                    </div>
                    <div class="col-12 col-md-4">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-value" id="completedRequests">0</div>
                    <div class="stat-label">Completed Requests</div>
                        </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                            <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Tenant</th>
                                    <th style="width: 8%;">Description</th>
                                    <th style="width: 6%;">Status</th>
                                    <th style="width: 10%;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="maintenanceList">
                                <!-- Maintenance requests will be loaded here -->
                            </tbody>
                        </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payments Section -->
        <div id="paymentsSection" class="section" style="display: none;">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-money-bill-wave me-2"></i>Payments</h2>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-12 col-md-4">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="stat-value" id="totalRevenue">₱0</div>
                            <div class="stat-label">Total Revenue</div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <div class="stat-value" id="monthlyRevenue">₱0</div>
                            <div class="stat-label">Monthly Revenue</div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-exclamation-circle"></i>
                            </div>
                            <div class="stat-value" id="pendingPayments">0</div>
                            <div class="stat-label">Pending Payments</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="bg-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Tenant</th>
                                        <th>Apartment Unit</th>
                                        <th>Amount</th>
                                        <th>Payment Method</th>
                                        <th style="width: 6%;">Status</th>
                                        <th>Recorded By</th>
                                        <th style="width: 10%;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="paymentsList">
                                    <!-- Payments will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reportsSection" class="section" style="display: none;">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-file-alt me-2"></i>Reports</h2>
                </div>

                <div class="row g-3">
                    <div class="col-12 col-md-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title mb-4">Revenue Report</h5>
                                <canvas id="revenueReportChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title mb-4">Occupancy Report</h5>
                                <canvas id="occupancyReportChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Account Management Section -->
        <div id="accountManagementSection" class="section" style="display: none;">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
                    <h2><i class="fas fa-user-cog me-2"></i>Account Management</h2>
                    <div class="d-flex gap-2 account-actions">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createAccountModal">
                            <i class="fas fa-plus me-2"></i>Add Account
                          </button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-3 account-filters">
                            <div class="col-md-4">
                                <label for="roleFilter" class="form-label">Filter by Role</label>
                                <select class="form-select" id="roleFilter" onchange="filterAccounts()">
                                    <option value="">All Roles</option>
                                    <option value="admin">Admin</option>
                                    <option value="staff">Staff</option>
                                    <option value="tenant">Tenant</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="statusFilter" class="form-label">Filter by Status</label>
                                <select class="form-select" id="statusFilter" onchange="filterAccounts()">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="pending">Pending</option>
                                    <option value="suspended">Suspended</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="searchAccount" class="form-label">Search</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="searchAccount" placeholder="Search by username or email" onkeyup="filterAccounts()">
                                    <button class="btn btn-outline-secondary" type="button" onclick="resetFilters()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="row g-3 mb-4">
                    <div class="col-12 col-sm-6 col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-value" id="totalAccounts">0</div>
                            <div class="stat-label">Total Accounts</div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-user-check"></i>
                            </div>
                            <div class="stat-value" id="activeAccounts">0</div>
                            <div class="stat-label">Active Accounts</div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-user-clock"></i>
                            </div>
                            <div class="stat-value" id="pendingAccounts">0</div>
                            <div class="stat-label">Pending Accounts</div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-user-slash"></i>
                            </div>
                            <div class="stat-value" id="suspendedAccounts">0</div>
                            <div class="stat-label">Suspended Accounts</div>
                        </div>
                    </div>
                </div>

                <!-- Accounts Table -->
                <div id="accountCardsMobile" class="account-cards-mobile d-block d-md-none"></div>
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Photo</th>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Apartment Unit</th>
                                        <th>Created At</th>
                                        <th style="width: 10%;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="accountsList">
                                    <!-- Accounts will be loaded here with data-label attributes -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Complaints Section -->
        <div id="complaintsSection" class="section" style="display: none;">
            <div class="container-fluid">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-2">
                    <h2><i class="fas fa-exclamation-circle me-2"></i>Complaints Management</h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" onclick="toggleComplaintView('table')">
                            <i class="fas fa-list me-1"></i> List View
                        </button>
                        <button class="btn btn-outline-primary" onclick="toggleComplaintView('dashboard')">
                            <i class="fas fa-chart-pie me-1"></i> Dashboard
                        </button>
                    </div>
                </div>

                <!-- Complaint Statistics -->
                <div class="row g-3 mb-4">
                    <div class="col-6 col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-clipboard-list"></i>
                            </div>
                            <div class="stat-value" id="total-complaints">0</div>
                            <div class="stat-label">Total Complaints</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon text-warning">
                                <i class="fas fa-hourglass-half"></i>
                            </div>
                            <div class="stat-value text-warning" id="pending-complaints">0</div>
                            <div class="stat-label">Pending</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon text-info">
                                <i class="fas fa-tools"></i>
                            </div>
                            <div class="stat-value text-info" id="in-progress-complaints">0</div>
                            <div class="stat-label">In Progress</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon text-success">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-value text-success" id="completed-complaints">0</div>
                            <div class="stat-label">Completed</div>
                        </div>
                    </div>
                </div>

                <!-- Complaint Dashboard View (Charts and Analysis) -->
                <div id="complaint-dashboard-view" class="mb-4" style="display: none;">
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="card-title"><i class="fas fa-chart-pie me-2"></i>Complaint Categories</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="complaint-category-chart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="card-title"><i class="fas fa-chart-bar me-2"></i>Complaint Status</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="complaint-status-chart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="card-title"><i class="fas fa-exclamation-triangle me-2"></i>Complaint Urgency</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="complaint-urgency-chart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="card-title"><i class="fas fa-language me-2"></i>Complaint Language</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="complaint-language-chart" height="250"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="card-title"><i class="fas fa-chart-line me-2"></i>Complaint Trend & Prediction</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="complaint-trend-prediction-chart" height="250"></canvas>
                                    <div id="complaint-prediction-summary" class="mt-3 text-muted small"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="card analytics h-100">
                                <div class="card-header">
                                    <h5 class="card-title"><i class="fas fa-arrow-up me-2"></i>Predicted Top Rising Categories</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="complaint-category-prediction-chart" height="250"></canvas>
                                    <div id="complaint-category-prediction-summary" class="mt-3 text-muted small"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="card analytics h-100">
                                <div class="card-header">
                                    <h5 class="card-title"><i class="fas fa-clock me-2"></i>Avg. Resolution Time</h5>
                                </div>
                                <div class="card-body d-flex flex-column align-items-center justify-content-center">
                                    <div class="display-5 fw-bold mb-2" id="complaint-avg-resolution-time">--</div>
                                    <div class="text-muted">Average time to resolve a complaint</div>
                                    <canvas id="complaint-avg-resolution-sparkline" height="60" style="max-width: 100%;"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="card analytics h-100">
                                <div class="card-header">
                                    <h5 class="card-title"><i class="fas fa-users me-2"></i>Repeat Complainants</h5>
                                </div>
                                <div class="card-body">
                                    <ul class="list-group" id="complaint-repeat-complainants-list"></ul>
                                    <div id="complaint-repeat-complainants-summary" class="mt-3 text-muted small"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                          <div class="card analytics h-100" id="category-trends-prediction-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                              <h5 class="card-title mb-0"><i class="fas fa-chart-line me-2"></i>Category Trends Prediction <span class="fw-normal" style="font-size:0.85em;">(Holt-Winters Exponential Smoothing)</span></h5>
                              <div class="btn-group btn-group-sm" role="group" aria-label="Time Granularity">
                                <button type="button" class="btn btn-outline-primary active" id="trend-toggle-week">Week</button>
                                <button type="button" class="btn btn-outline-primary" id="trend-toggle-month">Month</button>
                                <button type="button" class="btn btn-outline-primary" id="trend-toggle-year">Year</button>
                              </div>
                            </div>
                            <div class="card-body">
                              <canvas id="category-trends-prediction-chart" height="135"></canvas>
                              <div class="d-flex flex-wrap align-items-center gap-3 mt-3" id="category-trends-prediction-legend"></div>
                              <div class="mt-3" id="category-trends-prediction-summary"></div>
                            </div>
                          </div>
                        </div>
                    </div>
                </div>

                <!-- Complaints Filter -->
                <div class="card mb-4" id="complaints-filter-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title m-0"><i class="fas fa-filter me-2"></i>Filter Complaints</h5>
                        <button class="btn btn-sm btn-link d-md-none" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="false">
                            <i class="fas fa-caret-down"></i>
                        </button>
                    </div>
                    <div class="card-body collapse show" id="filterCollapse">
                        <div class="row g-3">
                            <div class="col-12 col-md-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="complaint-status-filter">
                                    <option value="">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="assigned">Assigned</option>
                                    <option value="in_progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>
                            <div class="col-12 col-md-3">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="complaint-category-filter">
                                    <option value="">All Categories</option>
                                    <option value="electrical">Electrical</option>
                                    <option value="plumbing">Plumbing</option>
                                    <option value="structural">Structural</option>
                                    <option value="hvac">HVAC</option>
                                    <option value="pest_control">Pest Control</option>
                                    <option value="security">Security</option>
                                    <option value="noise_complaint">Noise Complaint</option>
                                </select>
                            </div>
                            <div class="col-12 col-md-3">
                                <label class="form-label">Urgency</label>
                                <select class="form-select" id="complaint-urgency-filter">
                                    <option value="">All Urgency</option>
                                    <option value="High">High</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                            <div class="col-12 col-md-3">
                                <label class="form-label">Search</label>
                                <input type="text" class="form-control" id="complaint-search-filter" placeholder="Search complaints...">
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label">Date Range</label>
                                <div class="input-group">
                                    <input type="date" class="form-control" id="complaint-date-from">
                                    <span class="input-group-text">to</span>
                                    <input type="date" class="form-control" id="complaint-date-to">
                                </div>
                            </div>
                            <div class="col-6 col-md-3 d-flex align-items-end">
                                <button class="btn btn-primary w-100" onclick="filterComplaints()">
                                    <i class="fas fa-search me-2"></i>Apply Filters
                                </button>
                            </div>
                            <div class="col-6 col-md-3 d-flex align-items-end">
                                <button class="btn btn-outline-secondary w-100" onclick="resetComplaintFilters()">
                                    <i class="fas fa-undo me-2"></i>Reset
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Complaints Table View -->
                <div id="complaint-table-view" class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0" style="table-layout: fixed;">
                                <thead class="bg-light">
                                    <tr>
                                        <th style="width: 8%;">Date</th>
                                        <th style="width: 10%;">Tenant</th>
                                        <th style="width: 22%;">Description</th>
                                        <th class="d-none d-md-table-cell" style="width: 10%;">Category</th>
                                        <th class="d-none d-md-table-cell" style="width: 9%;">Unit</th>
                                        <th class="d-none d-md-table-cell" style="width: 9%;">Location</th>
                                        <th class="d-none d-md-table-cell" style="width: 8%;">Urgency</th>
                                        <th style="width: 6%;">Status</th>
                                        <th style="width: 10%;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="complaintsList">
                                    <!-- Complaints will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Complaint Detail Modal -->
        <div class="modal fade" id="complaintDetailModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable modal-fullscreen-sm-down">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-clipboard-check me-2"></i>Complaint Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6 class="text-muted mb-2">Complaint ID</h6>
                                <p class="mb-3" id="detail-complaint-id">-</p>
                                
                                <h6 class="text-muted mb-2">Tenant</h6>
                                <p class="mb-3" id="detail-tenant">-</p>
                                
                                <h6 class="text-muted mb-2">Date Submitted</h6>
                                <p class="mb-3" id="detail-date">-</p>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted mb-2">Status</h6>
                                <p class="mb-3"><span class="badge" id="detail-status">-</span></p>
                                
                                <h6 class="text-muted mb-2">Category</h6>
                                <p class="mb-3" id="detail-category">-</p>
                                
                                <h6 class="text-muted mb-2">Location</h6>
                                <p class="mb-3" id="detail-location">-</p>
                                
                                <h6 class="text-muted mb-2">Urgency</h6>
                                <p class="mb-3"><span class="badge" id="detail-urgency">-</span></p>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h6 class="text-muted mb-2">Description</h6>
                            <div class="p-3 bg-light rounded" id="detail-description">-</div>
                        </div>
                        
                        <div class="mb-4">
                            <h6 class="text-muted mb-2">Notes</h6>
                            <div class="p-3 bg-light rounded" id="detail-notes">-</div>
                        </div>
                        
                        <div class="mb-4" id="detail-assigned-section">
                            <h6 class="text-muted mb-2">Assigned To</h6>
                            <div class="p-3 bg-light rounded">
                                <div id="detail-assigned-info">No one assigned yet</div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h6 class="text-muted mb-2">Update Status</h6>
                            <div class="d-flex flex-column flex-md-row gap-2">
                                <select class="form-select" id="update-status">
                                    <option value="pending">Pending</option>
                                    <option value="assigned">Assigned</option>
                                    <option value="in_progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                </select>
                                <button class="btn btn-primary" onclick="updateComplaintStatus()">
                                    <i class="fas fa-save me-2"></i>Update
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h6 class="text-muted mb-2">Add Notes</h6>
                            <textarea class="form-control mb-2" id="update-notes" rows="3" placeholder="Add notes about this complaint..."></textarea>
                            <button class="btn btn-outline-primary" onclick="addComplaintNotes()">
                                <i class="fas fa-plus me-2"></i>Add Notes
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <h6 class="text-muted mb-2">Assign Maintenance Personnel</h6>
                            <div class="d-flex flex-column flex-md-row gap-2">
                                <select class="form-select" id="assign-personnel">
                                    <!-- Personnel options will be populated based on category -->
                                </select>
                                <button class="btn btn-success" onclick="assignMaintenancePersonnel()">
                                    <i class="fas fa-user-check me-2"></i>Assign
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment History Section -->
        <div id="paymentHistorySection" class="section" style="display: none;">
            <div class="container-fluid">
                <!-- Header with Quick Actions -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-history me-2"></i>Payment History</h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" onclick="showRecordPaymentModal()">
                            <i class="fas fa-plus me-2"></i>Quick Record Payment
                        </button>
                    </div>
                </div>

                <!-- Payment Statistics Cards -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="stat-value" id="total-payments">0</div>
                            <div class="stat-label">Total Payments</div>
                            <div class="stat-trend">
                                <i class="fas fa-chart-line me-1"></i>
                                <span id="total-trend">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon text-success">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-value text-success" id="completed-payments">0</div>
                            <div class="stat-label">Completed</div>
                            <div class="stat-trend positive">
                                <i class="fas fa-arrow-up me-1"></i>
                                <span id="completed-trend">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon text-warning">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-value text-warning" id="pending-payments">0</div>
                            <div class="stat-label">Pending</div>
                            <div class="stat-trend">
                                <i class="fas fa-clock me-1"></i>
                                <span id="pending-trend">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon text-danger">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <div class="stat-value text-danger" id="failed-payments">0</div>
                            <div class="stat-label">Failed</div>
                            <div class="stat-trend negative">
                                <i class="fas fa-arrow-down me-1"></i>
                                <span id="failed-trend">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Filters -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="payment-status-filter" onchange="filterPayments()">
                                    <option value="">All Status</option>
                                    <option value="completed">Completed</option>
                                    <option value="pending">Pending</option>
                                    <option value="failed">Failed</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Payment Method</label>
                                <select class="form-select" id="payment-method-filter" onchange="filterPayments()">
                                    <option value="">All Methods</option>
                                    <option value="credit_card">Credit Card</option>
                                    <option value="bank_transfer">Bank Transfer</option>
                                    <option value="cash">Cash</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Date Range</label>
                                <div class="input-group">
                                    <input type="date" class="form-control" id="payment-date-from" onchange="filterPayments()">
                                    <span class="input-group-text">to</span>
                                    <input type="date" class="form-control" id="payment-date-to" onchange="filterPayments()">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-outline-secondary w-100" onclick="resetPaymentFilters()">
                                    <i class="fas fa-undo me-2"></i>Reset
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payments Table -->
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Tenant</th>
                                        <th>Apartment Unit</th>
                                        <th>Amount</th>
                                        <th>Payment Method</th>
                                        <th style="width: 6%;">Status</th>
                                        <th>Recorded By</th>
                                        <th style="width: 10%;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="payments-table-body">
                                    <!-- Payment rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manage Listing Section -->
        <div id="manageListingSection" class="section" style="display: none;">
            <div class="container-fluid">
            <div class="section-header">
              <h2 class="section-title"><i class="fas fa-list-alt me-2"></i>Manage Listings</h2>
              <button class="btn btn-primary" onclick="showAddListingModal()">
                <i class="fas fa-plus me-2"></i> Add New Listing
              </button>
                </div>
            <div class="card mb-4">
              <div class="card-body">
                <div class="row g-3 align-items-end">
                  <div class="col-md-4">
                    <label class="form-label" for="listingSearch">Search</label>
                    <div class="input-group">
                      <input type="text" class="form-control" id="listingSearch" placeholder="Search listings...">
                      <button class="btn btn-outline-primary" id="listingSearchBtn" type="button">
                        <i class="fas fa-search"></i>
                      </button>
                      <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('listingSearch').value='';loadListings();">
                        <i class="fas fa-times"></i>
                      </button>
                        </div>
                        </div>
                  <div class="col-md-8 d-flex gap-2 flex-wrap">
                    <label class="form-label mb-0 me-2">Status:</label>
                    <button class="btn btn-outline-primary filter-btn active" data-filter="all">All</button>
                    <button class="btn btn-outline-primary filter-btn" data-filter="available">Available</button>
                    <button class="btn btn-outline-primary filter-btn" data-filter="pending">Pending</button>
                    <button class="btn btn-outline-primary filter-btn" data-filter="inactive">Inactive</button>
                    </div>
                </div>
              </div>
            </div>
                    <div class="listings-grid" id="listingsGrid">
                        <!-- Listing cards will be dynamically populated here -->
                </div>
            </div>
        </div>

        <!-- Booking Section -->
        <div id="bookingSection" class="section" style="display: none;">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-calendar-check me-2"></i>Property Viewing Bookings</h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" onclick="showCreateBookingModal()">
                            <i class="fas fa-plus me-2"></i>Create New Booking
                        </button>
                    </div>
                </div>

                <!-- Booking Statistics -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div class="stat-value" id="total-bookings">0</div>
                            <div class="stat-label">Total Bookings</div>
                            <div class="stat-trend">
                                <i class="fas fa-chart-line me-1"></i>
                                <span id="booking-trend">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon text-warning">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-value text-warning" id="pending-bookings">0</div>
                            <div class="stat-label">Pending</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon text-success">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-value text-success" id="approved-bookings">0</div>
                            <div class="stat-label">Approved</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon text-info">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <div class="stat-value text-info" id="approval-rate">0%</div>
                            <div class="stat-label">Approval Rate</div>
                        </div>
                    </div>
                </div>

                <!-- Booking Filters and Views Toggle -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label for="booking-status-filter" class="form-label">Status</label>
                                        <select class="form-select" id="booking-status-filter" onchange="filterBookings()">
                                            <option value="">All Status</option>
                                            <option value="pending">Pending</option>
                                            <option value="approved">Approved</option>
                                            <option value="completed">Completed</option>
                                            <option value="canceled">Canceled</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="booking-date-from" class="form-label">From Date</label>
                                        <input type="date" class="form-control" id="booking-date-from" onchange="filterBookings()">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="booking-date-to" class="form-label">To Date</label>
                                        <input type="date" class="form-control" id="booking-date-to" onchange="filterBookings()">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="booking-search" class="form-label">Search</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="booking-search" placeholder="Search by name or property" onkeyup="filterBookings()">
                                    <button class="btn btn-outline-secondary" type="button" onclick="resetBookingFilters()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- View Toggle Buttons -->
                <div class="d-flex justify-content-end mb-3">
                    <div class="btn-group">
                        <button id="list-view-btn" class="btn btn-outline-primary active" onclick="switchBookingView('list')">
                            <i class="fas fa-list me-2"></i>List View
                        </button>
                        <button id="calendar-view-btn" class="btn btn-outline-primary" onclick="switchBookingView('calendar')">
                            <i class="fas fa-calendar-alt me-2"></i>Calendar View
                        </button>
                    </div>
                </div>

                <!-- List View -->
                <div id="booking-list-view">
                    <div class="card">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="bg-light">
                                        <tr>
                                            <th>ID</th>
                                            <th>Property</th>
                                            <th>Date</th>
                                            <th>Time</th>
                                            <th>Contact Name</th>
                                            <th>Phone</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bookingsList">
                                        <!-- Bookings will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Calendar View -->
                <div id="booking-calendar-view" style="display: none;">
                    <div class="calendar-controls mb-3">
                        <div class="btn-group">
                            <button class="btn btn-outline-primary" onclick="previousMonth()">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="btn btn-outline-primary calendar-title-btn" id="calendar-title">Month Year</button>
                            <button class="btn btn-outline-primary" onclick="nextMonth()">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="calendar-view">
                        <div class="calendar-grid" id="calendar-grid">
                            <!-- Calendar will be generated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Visitor & Tenant Logs Section -->
        <div id="visitorLogsSection" class="section" style="display: none;">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-clipboard-list me-2"></i>Visitor & Tenant Logs</h2>
                    <button id="guardModeToggle" class="guard-mode-toggle">
                        <i class="fas fa-shield-alt"></i> Guard Mode
                    </button>
                </div>
                <div class="dashboard-stats mb-4">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-list"></i></div>
                        <div class="stat-value" id="statTotalLogs">0</div>
                        <div class="stat-label">Total Logs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-user-friends"></i></div>
                        <div class="stat-value" id="statTotalVisitors">0</div>
                        <div class="stat-label">Total Visitors</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-users"></i></div>
                        <div class="stat-value" id="statTotalTenants">0</div>
                        <div class="stat-label">Total Tenants</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-percentage"></i></div>
                        <div class="stat-value" id="statSuccessRate">0%</div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                </div>
                <div class="card mb-4" id="footTrafficCard">
                    <div class="card-body">
                        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3 gap-2 gap-md-3">
                            <div class="d-flex align-items-center gap-2">
                                <h5 class="card-title mb-0 d-flex align-items-center">
                                    <i class="fas fa-walking me-2"></i>Foot Traffic
                                    <span class="badge bg-info ms-2" id="footTrafficPeriod">Today</span>
                                </h5>
                                <button class="btn btn-outline-secondary btn-sm ms-2" id="toggleComparisonBtn" type="button">
                                    <i class="fas fa-exchange-alt"></i> Compare
                                </button>
                            </div>
                            <div class="btn-group gap-2" id="footTrafficToggleGroup" role="group">
                                <button type="button" class="btn btn-outline-primary btn-sm" data-range="hour">Hour</button>
                                <button type="button" class="btn btn-outline-primary btn-sm" data-range="day">Day</button>
                                <button type="button" class="btn btn-outline-primary btn-sm" data-range="week">Week</button>
                                <button type="button" class="btn btn-outline-primary btn-sm" data-range="month">Month</button>
                            </div>
                        </div>
                        <div id="comparisonSelectors" class="mb-2" style="display:none;">
                            <div class="btn-group gap-2" id="footTrafficCompareToggleGroup" role="group">
                                <button type="button" class="btn btn-outline-warning btn-sm" data-range="hour">Hour</button>
                                <button type="button" class="btn btn-outline-warning btn-sm" data-range="day">Day</button>
                                <button type="button" class="btn btn-outline-warning btn-sm" data-range="week">Week</button>
                                <button type="button" class="btn btn-outline-warning btn-sm" data-range="month">Month</button>
                            </div>
                            <span class="badge bg-warning ms-2" id="footTrafficComparePeriod">Previous</span>
                        </div>
                        <div class="d-flex align-items-center gap-3 mb-2" id="footTrafficLegend">
                            <span class="badge" style="background:#6366f1;color:#fff;min-width:60px;">Primary</span>
                            <span class="badge" style="background:#f59e42;color:#fff;min-width:60px;">Comparison</span>
                            <span id="comparisonStats" class="ms-auto"></span>
                        </div>
                        <canvas id="footTrafficChart" height="90"></canvas>
                        <div class="text-end mt-2">
                            <small class="text-muted">Current time: <span id="footTrafficCurrentTime"></span></small>
                        </div>
                    </div>
                </div>
                <div class="card mb-4" id="visitorLogsFilterCard">
                    <div class="card-body">
                        <form id="visitorLogsFilterForm">
                            <div class="row g-3 align-items-end">
                                <div class="col-md-3">
                                    <label for="filterDateFrom" class="form-label">Date From</label>
                                    <input type="date" class="form-control" id="filterDateFrom" name="dateFrom">
                                </div>
                                <div class="col-md-3">
                                    <label for="filterDateTo" class="form-label">Date To</label>
                                    <input type="date" class="form-control" id="filterDateTo" name="dateTo">
                                </div>
                                <div class="col-md-2">
                                    <label for="filterType" class="form-label">Type</label>
                                    <select class="form-select" id="filterType" name="type">
                                        <option value="">All</option>
                                        <option value="Visitor">Visitor</option>
                                        <option value="Admin">Admin</option>
                                        <option value="Staff">Staff</option>
                                        <option value="Tenant">Tenant</option>
                                        <option value="Unknown">Unknown</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="filterEntryMethod" class="form-label">Entry Method</label>
                                    <select class="form-select" id="filterEntryMethod" name="entryMethod">
                                        <option value="">All</option>
                                        <option value="RFID">RFID</option>
                                        <option value="QR">QR</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="filterStatus" class="form-label">Status</label>
                                    <select class="form-select" id="filterStatus" name="status">
                                        <option value="">All</option>
                                        <option value="Approved">Approved</option>
                                        <option value="Expired">Expired</option>
                                        <option value="Failed">Failed</option>
                                        <option value="Revoked">Revoked</option>
                                        <option value="Success">Success</option>
                                    </select>
                                </div>
                                <div class="col-12 col-md-auto d-flex justify-content-md-end align-items-end ms-md-auto">
                                    <button type="button" class="btn btn-outline-secondary w-100 mt-2 mt-md-0" id="resetVisitorLogsFilters">
                                        <i class="fas fa-times me-1"></i>Reset
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Guard Mode Container -->
                <div id="guardModeContainer">
                    <div class="guard-mode-header">
                        <div class="guard-mode-title">
                            <i class="fas fa-shield-alt"></i>
                            Guard Mode
                        </div>
                        <div class="guard-mode-controls">
                            <div class="guard-mode-status">
                                <div class="status-indicator"></div>
                                <span>Live Monitoring</span>
                                <span class="ms-2">•</span>
                                <button id="securityModeToggle" class="secure-mode-indicator"><i class="fas fa-lock"></i> Secure Mode</button>
                                <span class="ms-2">•</span>
                                <span class="ms-2">Current Time: <span id="guardModeCurrentTime">00:00:00</span></span>
                                <span class="ms-2">•</span>
                                <span class="ms-2">Entries: <span id="guardModeEntryCount">0</span></span>
                            </div>
                            <div class="guard-mode-filter">
                                <span class="filter-label">Filter:</span>
                                <div class="guard-filter-buttons">
                                    <button class="guard-filter-btn active" data-filter="all">All</button>
                                    <button class="guard-filter-btn" data-filter="RFID">RFID</button>
                                    <button class="guard-filter-btn" data-filter="QR">QR</button>
                                </div>
                            </div>
                            <button id="fullscreenBtn" class="fullscreen-btn" title="Toggle Fullscreen">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div id="guardModeEntriesGrid" class="guard-mode-grid">
                        <!-- Entry cards will be dynamically added here -->
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Time</th>
                                        <th>RFID</th>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Entry Method</th>
                                        <th>Purpose</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="logsTableBody">
                                    <!-- Logs will be dynamically loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Listing Modal -->
    <div class="modal fade" id="listingModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="listingModalTitle">Add New Listing</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="listingForm">
                        <input type="hidden" id="listingId">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Title</label>
                                <input type="text" class="form-control" id="listingTitle" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Type</label>
                                <select class="form-select" id="listingType" required>
                                    <option value="">Select Type</option>
                                    <option value="apartment">Apartment</option>
                                    <option value="house">House</option>
                                    <option value="condo">Condominium</option>
                                    <option value="office">Office Space</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Price</label>
                                <div class="input-group">
                                    <span class="input-group-text">₱</span>
                                    <input type="number" class="form-control" id="listingPrice" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Floor Area (sq.m)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="listingArea" required>
                                    <span class="input-group-text">sq.m</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="listingStatus" required>
                                    <option value="available">Available</option>
                                    <option value="rented">Rented</option>
                                    <option value="maintenance">Under Maintenance</option>
                                    <option value="pending">Pending</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" id="listingDescription" rows="3" required></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Features</label>
                                <input type="hidden" id="listingFeatures">
                                <div class="feature-buttons">
                                    <button type="button" class="btn feature-btn" data-feature="WiFi">WiFi</button>
                                    <button type="button" class="btn feature-btn" data-feature="Parking">Parking</button>
                                    <button type="button" class="btn feature-btn" data-feature="Pool">Pool</button>
                                    <button type="button" class="btn feature-btn" data-feature="AC">Air Conditioning</button>
                                    <button type="button" class="btn feature-btn" data-feature="Balcony">Balcony</button>
                                    <button type="button" class="btn feature-btn" data-feature="Gym">Gym</button>
                                    <button type="button" class="btn feature-btn" data-feature="Security">Security</button>
                                    <button type="button" class="btn feature-btn" data-feature="Elevator">Elevator</button>
                                    <button type="button" class="btn feature-btn" data-feature="Furnished">Furnished</button>
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Images</label>
                                <div id="listingImagesContainer" style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                                    <input type="file" class="form-control mb-2" id="listingImages" name="listingImages" accept="image/*">
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm mt-1" id="addImageInputBtn">
                                    <i class="fas fa-plus me-1"></i>Add Another Image
                                </button>
                                <small class="text-muted d-block mt-1">You can select multiple images</small>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveListing()">Save Listing</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Listing Modal -->
    <div class="modal fade" id="viewListingModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-info-circle me-2"></i>Listing Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="listingDetailsContent">
                    <!-- Listing details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Create Account Modal -->
    <div class="modal fade" id="createAccountModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-plus me-2"></i>Create New Account
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createAccountForm" onsubmit="createAccount(event)">
                        <div class="mb-3">
                            <label for="newUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="newUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="newEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="newEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="newRole" class="form-label">Role</label>
                            <select class="form-select" id="newRole" required>
                                <option value="admin">Admin</option>
                                <option value="staff">Staff</option>
                                <option value="tenant">Tenant</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="newStatus" class="form-label">Status</label>
                            <select class="form-select" id="newStatus" required>
                                <option value="active">Active</option>
                                <option value="pending">Pending</option>
                                <option value="suspended">Suspended</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="newPhoto" class="form-label">Profile Photo</label>
                            <input type="file" class="form-control" id="newPhoto" name="newPhoto" accept="image/*">
                        </div>
                        <div class="mb-3" id="tenantUnitGroup" style="display:none;">
                            <label for="tenantUnit" class="form-label">Apartment Unit</label>
                            <select class="form-select" id="tenantUnit" name="tenantUnit">
                                <option value="">Select Unit</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="newRfid" class="form-label">RFID Tag</label>
                            <input type="text" class="form-control" id="newRfid" name="newRfid" placeholder="Enter RFID Tag (optional)">
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>Create Account
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Account Modal -->
    <div class="modal fade" id="editAccountModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-edit me-2"></i>Edit Account
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editAccountForm" onsubmit="updateAccount(event)">
                        <div class="mb-3">
                            <label for="editAccountId" class="form-label">Account ID</label>
                            <input type="text" class="form-control" id="editAccountId" readonly>
                        </div>
                        <div class="mb-3 text-center">
                            <img id="editPhotoPreview" src="" alt="Profile Photo" class="rounded-circle mb-2" style="width:64px;height:64px;object-fit:cover;border:2px solid #e3e8ef;">
                            <div>
                                <input type="file" class="form-control mt-2" id="editPhoto" name="editPhoto" accept="image/*" style="max-width:220px;margin:0 auto;">
                            </div>
                            <small class="text-muted">Upload a new photo to replace the current one.</small>
                        </div>
                        <div class="mb-3">
                            <label for="editUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="editUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="editEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="editEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="editRole" class="form-label">Role</label>
                            <select class="form-select" id="editRole" required>
                                <option value="admin">Admin</option>
                                <option value="staff">Staff</option>
                                <option value="tenant">Tenant</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editStatus" class="form-label">Status</label>
                            <select class="form-select" id="editStatus" required>
                                <option value="active">Active</option>
                                <option value="pending">Pending</option>
                                <option value="suspended">Suspended</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editRfid" class="form-label">RFID Tag</label>
                            <input type="text" class="form-control" id="editRfid" name="editRfid" placeholder="Enter RFID Tag (optional)">
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>Update Account
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Property Modal -->
    <div class="modal fade" id="createPropertyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus-circle me-2"></i>Add New Property
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createPropertyForm" onsubmit="createProperty(event)">
                        <div class="mb-3">
                            <label for="propertyName" class="form-label">Property Name</label>
                            <input type="text" class="form-control" id="propertyName" required>
                        </div>
                        <div class="mb-3">
                            <label for="propertyType" class="form-label">Type</label>
                            <select class="form-select" id="propertyType" required>
                                <option value="apartment">Apartment</option>
                                <option value="house">House</option>
                                <option value="condo">Condominium</option>
                                <option value="office">Office Space</option>
                            </select>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>Add Property
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div class="modal fade" id="resetPasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-key me-2"></i>Reset Password
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="resetPasswordForm" onsubmit="resetPassword(event)">
                        <input type="hidden" id="resetPasswordAccountId">
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" name="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="resetNewPassword" class="form-label">Confirm Password</label>
                            <input type="password" class="form-control" id="resetNewPassword" name="resetNewPassword" required>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>Reset Password
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add toast container -->
    <div class="toast-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/db-manager.js"></script>
    <script src="js/db-compatibility.js"></script>
    <script src="js/complaint-manager.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/payment-history-db.js"></script>
    <script src="js/listing-db-global.js"></script>
    <script src="js/booking-db.js"></script>
    <script src="js/booking-manager.js"></script>
    <script src="js/booking-pagination.js"></script>
    <script src="js/payment-pagination.js"></script>
    <script src="js/enhancements.js"></script>
    <script src="js/listing-pagination.js"></script>
    <script src="js/visitor-tenant-logs-pagination.js"></script>
    <script src="js/complaint-analytics.js"></script>

    <script>
        // Initialize database and load data
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Wait for Firebase to be ready
                if (typeof firebase !== 'undefined') {
                    window.firestoreDB = firebase.firestore();
                }
                if (typeof dbManager !== 'undefined') {
                await dbManager.initialize();
                }
                if (typeof paymentHistoryDB !== 'undefined') {
                    await paymentHistoryDB.initialize();
                }
                // Check if user is logged in and is an admin
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (!currentUser || currentUser.role !== 'admin') {
                    window.location.href = 'login.html';
                    return;
                }
                document.getElementById('userInfo').textContent = `Welcome, ${currentUser.username}`;
                // Set profile photo
                let photoUrl = currentUser.photoUrl;
                if (!photoUrl && window.dbManager && currentUser.id) {
                    // Try to fetch from db if not in localStorage
                    try {
                        const account = await dbManager.getAccount(currentUser.id);
                        photoUrl = account && account.photoUrl;
                    } catch {}
                }
                if (!photoUrl) {
                    photoUrl = 'https://ui-avatars.com/api/?name=' + encodeURIComponent(currentUser.username || 'User');
                }
                const avatarImg = document.getElementById('userAvatarImg');
                if (avatarImg) avatarImg.src = photoUrl;
                // await loadDashboardData(); // Disabled for now
                await loadAccounts();
                // Show dashboard section by default
                // showSection('dashboard'); // Disabled to allow section persistence
            } catch (error) {
                console.error('Failed to initialize:', error);
                showToast('Failed to initialize the application', 'error');
            }
        });

        // Initialize components
        document.addEventListener('DOMContentLoaded', () => {
            // Initial check for viewport size
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (window.innerWidth >= 768) {
                sidebar.style.transform = 'none';
                mainContent.style.marginLeft = 'var(--sidebar-width)';
            } else {
                sidebar.style.transform = 'translateX(-100%)';
                mainContent.style.marginLeft = '0';
            }
        });

        // Toggle sidebar function
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            
            if (window.innerWidth < 768) {
                if (sidebar.classList.contains('show')) {
                    // Close sidebar
                    sidebar.classList.remove('show');
                    sidebar.style.transform = 'translateX(-100%)';
                    document.body.style.overflow = '';
                } else {
                    // Open sidebar
                    sidebar.classList.add('show');
                    sidebar.style.transform = 'translateX(0)';
                    document.body.style.overflow = 'hidden';
                }
            }
        }

        // Handle window resize
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                const sidebar = document.getElementById('sidebar');
                const mainContent = document.querySelector('.main-content');
                
                if (window.innerWidth >= 768) {
                    // Desktop view
                    sidebar.classList.remove('show');
                    sidebar.style.transform = 'none';
                    mainContent.style.marginLeft = 'var(--sidebar-width)';
                    document.body.style.overflow = '';
                } else {
                    // Mobile view
                    mainContent.style.marginLeft = '0';
                    if (!sidebar.classList.contains('show')) {
                        sidebar.style.transform = 'translateX(-100%)';
                    }
                }
            }, 100);
        });

        // Update showSection function
        function showSection(sectionName, event) {
            try {
                console.log(`Showing section: ${sectionName}`);
                
            // Hide all sections
            document.querySelectorAll('.section, .section-content').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show selected section
            const selectedSection = document.getElementById(sectionName + 'Section') || document.getElementById(sectionName + '-section');
            if (selectedSection) {
                selectedSection.style.display = 'block';
                    console.log(`Section displayed: ${sectionName}`);
                
                // Load section-specific data
                if (sectionName === 'accountManagement') {
                    loadAccounts();
                } else if (sectionName === 'paymentHistory') {
                    loadPaymentHistory();
                } else if (sectionName === 'manageListing') {
                    loadListings();
                } else if (sectionName === 'booking') {
                    // Load booking data if the booking section is selected
                    if (typeof loadBookings === 'function') {
                        loadBookings();
                    }
                } else if (sectionName === 'visitorLogs') {
                    if (typeof window.initVisitorTenantLogs === 'function') {
                        window.initVisitorTenantLogs();
                    }
                }
                } else {
                    console.warn(`Section not found: ${sectionName}`);
            }
            
            // Update active nav link
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.classList.remove('active');
            });
                
                // Only update active class on the element if event is provided
                if (event && event.target && event.target.classList) {
            event.target.classList.add('active');
                } else {
                    // Try to find the nav link for this section and make it active
                    const navLink = document.querySelector(`.sidebar .nav-link[onclick*="${sectionName}"]`);
                    if (navLink) {
                        navLink.classList.add('active');
                    }
                }

            // Close sidebar on mobile after selection
            if (window.innerWidth < 768) {
                toggleSidebar();
                }
            } catch (error) {
                console.error('Error in showSection:', error);
            }
        }

        // Add loading state management
        function showLoading() {
            document.getElementById('loadingSpinner').classList.remove('d-none');
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').classList.add('d-none');
        }

        // Add toast notification function
        function showToast(message, type = 'success') {
            const toastContainer = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = `toast show`;
            toast.innerHTML = `
                <div class="toast-header">
                    <i class="fas fa-${type === 'success' ? 'check-circle text-success' : 'exclamation-circle text-danger'} me-2"></i>
                    <strong class="me-auto">${type === 'success' ? 'Success' : 'Error'}</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            `;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        async function loadAccounts() {
            showLoading();
            try {
                const accounts = await dbManager.getAllAccounts();
                let listings = [];
                if (window.listingsManager && window.listingsManager.getAllListings) {
                    listings = await window.listingsManager.getAllListings();
                } else if (window.listingDB && window.listingDB.getAllListings) {
                    listings = await window.listingDB.getAllListings();
                }
                const accountsList = document.getElementById('accountsList');
                
                // Update statistics
                document.getElementById('totalAccounts').textContent = accounts.length;
                document.getElementById('activeAccounts').textContent = accounts.filter(a => a.status === 'active').length;
                document.getElementById('pendingAccounts').textContent = accounts.filter(a => a.status === 'pending').length;
                document.getElementById('suspendedAccounts').textContent = accounts.filter(a => a.status === 'suspended').length;
                
                // Render accounts table with enhanced mobile view
                accountsList.innerHTML = accounts.map(account => {
                    let unitCell = '';
                    if (account.role === 'tenant' && account.unitId) {
                        const unit = listings.find(l => l.id === account.unitId);
                        if (unit) {
                            unitCell = `<div><strong>${unit.title || unit.id}</strong>${unit.area ? ` (${unit.area} sqm)` : ''}</div>`;
                        } else {
                            unitCell = '<span class="text-muted">Not found</span>';
                        }
                    } else {
                        unitCell = '<span class="text-muted">-</span>';
                    }
                    // Profile photo logic
                    const photoUrl = account.photoUrl || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(account.username || 'User');
                    return `
                    <tr class="account-card" data-role="${account.role}" data-status="${account.status}">
                            <td data-label="Photo">
                                <img src="${photoUrl}" alt="Profile Photo" class="rounded-circle account-photo-thumb" style="width:36px;height:36px;object-fit:cover;cursor:pointer;border:2px solid #e3e8ef;" onclick="showProfilePhotoModal('${photoUrl}', '${account.username || ''}')">
                            </td>
                        <td data-label="Username">
                            <span class="role-badge ${account.role}">${account.username}</span>
                        </td>
                        <td data-label="Email">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-envelope me-2 text-muted"></i>
                                ${account.email}
                            </div>
                        </td>
                        <td data-label="Role">
                            <div class="role-indicator ${account.role}">
                                <i class="fas ${getRoleIcon(account.role)}"></i>
                                ${account.role}
                            </div>
                        </td>
                        <td data-label="Status">
                            <div class="status-indicator ${account.status}">
                                <i class="fas ${getStatusIcon(account.status)}"></i>
                                ${account.status}
                            </div>
                        </td>
                            <td data-label="Apartment Unit">${unitCell}</td>
                        <td data-label="Created At">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-calendar me-2 text-muted"></i>
                                ${new Date(account.createdAt).toLocaleDateString()}
                            </div>
                        </td>
                        <td data-label="Actions">
                            <div class="action-buttons">
                                <button onclick="editAccount('${account.id}')" class="btn btn-sm btn-primary" title="Edit">
                                    <i class="fas fa-edit"></i>
                            </button>
                                <button onclick="resetPasswordModal('${account.id}')" class="btn btn-sm btn-warning" title="Reset Password">
                                    <i class="fas fa-key"></i>
                            </button>
                                <button onclick="toggleAccountStatus('${account.id}')" class="btn btn-sm ${account.status === 'active' ? 'btn-danger' : 'btn-success'}" title="${account.status === 'active' ? 'Suspend' : 'Activate'}">
                                    <i class="fas fa-${account.status === 'active' ? 'ban' : 'check'}"></i>
                                </button>
                                <button onclick="deleteAccount('${account.id}')" class="btn btn-sm btn-danger" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    `;
                }).join('');
                
                showToast('Accounts loaded successfully');
            } catch (error) {
                console.error('Failed to load accounts:', error);
                showToast('Failed to load accounts', 'error');
            } finally {
                hideLoading();
            }
        }

        // Helper functions for icons and colors
        function getRoleIcon(role) {
            switch (role) {
                case 'admin': return 'fa-user-shield';
                case 'staff': return 'fa-user-tie';
                case 'tenant': return 'fa-user';
                default: return 'fa-user';
            }
        }

        function getStatusIcon(status) {
            switch (status) {
                case 'active': return 'fa-check-circle';
                case 'pending': return 'fa-clock';
                case 'suspended': return 'fa-ban';
                default: return 'fa-question-circle';
            }
        }

        function getRoleColor(role) {
            switch (role) {
                case 'admin': return 'primary';
                case 'staff': return 'info';
                case 'tenant': return 'success';
                default: return 'secondary';
            }
        }

        async function createAccount(event) {
            event.preventDefault();
            
            const username = document.getElementById('newUsername').value;
            const email = document.getElementById('newEmail').value;
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('newRole').value;
            const status = document.getElementById('newStatus').value;
            // Photo upload
            const photoInput = document.getElementById('newPhoto');
            let photoUrl = '';
            if (photoInput && photoInput.files && photoInput.files.length > 0) {
                const file = photoInput.files[0];
                // Upload to Firebase Storage
                const storageRef = firebase.storage().ref();
                const fileName = `accounts/${Date.now()}_${file.name}`;
                const fileRef = storageRef.child(fileName);
                await fileRef.put(file);
                photoUrl = await fileRef.getDownloadURL();
            }
            // Unit assignment for tenants
            let unitId = '';
            if (role === 'tenant') {
                unitId = document.getElementById('tenantUnit').value;
            }
            const rfidRaw = document.getElementById('newRfid').value.trim();
            const rfid = rfidRaw.replace(/[^0-9]/g, '');
            // Duplicate RFID validation
            if (rfid) {
                const allAccounts = await dbManager.getAllAccounts();
                const duplicate = allAccounts.find(acc => acc.rfid && acc.rfid === rfid);
                if (duplicate) {
                    showToast('RFID tag is already assigned to another account.', 'error');
                    return;
                }
            }
            try {
                await dbManager.createAccount({
                    username,
                    email,
                    password,
                    role,
                    status,
                    photoUrl,
                    unitId,
                    rfid: rfid || undefined,
                    createdAt: new Date().toISOString()
                });
                
                // Close modal and reset form
                const modal = bootstrap.Modal.getInstance(document.getElementById('createAccountModal'));
                modal.hide();
                document.getElementById('createAccountForm').reset();
                
                // Reload accounts
                loadAccounts();
                
                showToast('Account created successfully');
            } catch (error) {
                console.error('Failed to create account:', error);
                showToast(error.message || 'Failed to create account', 'error');
            }
        }

        async function editAccount(accountId) {
            try {
                const account = await dbManager.getAccount(accountId);
                if (!account) {
                    showToast('Account not found', 'error');
                    return;
                }
                document.getElementById('editAccountId').value = account.id;
                document.getElementById('editUsername').value = account.username;
                document.getElementById('editEmail').value = account.email;
                document.getElementById('editRole').value = account.role;
                document.getElementById('editStatus').value = account.status;
                document.getElementById('editRfid').value = account.rfid || '';
                // Show current photo
                const photoUrl = account.photoUrl || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(account.username || 'User');
                document.getElementById('editPhotoPreview').src = photoUrl;
                document.getElementById('editPhoto').value = '';
                // Show edit modal
                const editModal = new bootstrap.Modal(document.getElementById('editAccountModal'));
                editModal.show();
            } catch (error) {
                console.error('Failed to load account details:', error);
                showToast('Failed to load account details', 'error');
            }
        }

        async function updateAccount(event) {
            event.preventDefault();
            const accountId = document.getElementById('editAccountId').value;
            const username = document.getElementById('editUsername').value;
            const email = document.getElementById('editEmail').value;
            const role = document.getElementById('editRole').value;
            const status = document.getElementById('editStatus').value;
            const rfidRaw = document.getElementById('editRfid').value.trim();
            const rfid = rfidRaw.replace(/[^0-9]/g, '');
            // Photo upload
            const photoInput = document.getElementById('editPhoto');
            let photoUrl = document.getElementById('editPhotoPreview').src;
            if (photoInput && photoInput.files && photoInput.files.length > 0) {
                const file = photoInput.files[0];
                // Upload to Firebase Storage
                const storageRef = firebase.storage().ref();
                const fileName = `accounts/${Date.now()}_${file.name}`;
                const fileRef = storageRef.child(fileName);
                await fileRef.put(file);
                photoUrl = await fileRef.getDownloadURL();
            }
            // Duplicate RFID validation
            if (rfid) {
                const allAccounts = await dbManager.getAllAccounts();
                const duplicate = allAccounts.find(acc => acc.rfid && acc.rfid === rfid && acc.id !== accountId);
                if (duplicate) {
                    showToast('RFID tag is already assigned to another account.', 'error');
                    return;
                }
            }
            try {
                await dbManager.updateAccount(accountId, {
                    username,
                    email,
                    role,
                    status,
                    photoUrl,
                    rfid: rfid || undefined
                });
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editAccountModal'));
                modal.hide();
                // Reload accounts
                loadAccounts();
                showToast('Account updated successfully');
            } catch (error) {
                console.error('Failed to update account:', error);
                showToast('Failed to update account', 'error');
            }
        }

        function validatePasswordFields() {
            const form = document.getElementById('resetPasswordForm');
            const newPasswordField = form.querySelector('#newPassword');
            const confirmPasswordField = form.querySelector('#resetNewPassword');
            
            // Add event listeners to password fields
            newPasswordField.addEventListener('input', function() {
                console.log('New password changed:', this.value);
            });
            
            confirmPasswordField.addEventListener('input', function() {
                console.log('Confirm password changed:', this.value);
            });
            
            console.log('Form values:', {
                newPassword: newPasswordField.value,
                confirmPassword: confirmPasswordField.value
            });
            
            return {
                newPassword: newPasswordField.value.trim(),
                confirmPassword: confirmPasswordField.value.trim()
            };
        }

        async function resetPasswordModal(accountId) {
            // Ensure user is authenticated with Firebase
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                const user = JSON.parse(localStorage.getItem('currentUser'));
                if (user && user.email && user.password) {
                    try {
                        await firebase.auth().signInWithEmailAndPassword(user.email, user.password);
                        console.log('Re-authenticated with Firebase Auth');
                    } catch (error) {
                        console.error('Failed to re-authenticate:', error);
                        showToast('Authentication error. Please try logging in again.', 'error');
                        return;
                    }
                } else {
                    showToast('Please log in again to reset passwords', 'error');
                    return;
                }
            }

            document.getElementById('resetPasswordAccountId').value = accountId;
            const modal = new bootstrap.Modal(document.getElementById('resetPasswordModal'));
            modal.show();
        }

        async function resetPassword(event) {
            event.preventDefault();
            
            // Ensure user is authenticated with Firebase
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                showToast('Please log in again to reset passwords', 'error');
                return;
            }

            const form = document.getElementById('resetPasswordForm');
            const accountId = document.getElementById('resetPasswordAccountId').value;
            const newPasswordField = form.querySelector('#newPassword');
            const confirmPasswordField = form.querySelector('#resetNewPassword');
            
            const newPassword = newPasswordField.value.trim();
            const confirmPassword = confirmPasswordField.value.trim();
            
            if (!newPassword || !confirmPassword) {
                showToast('Please fill in both password fields', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }
            
            try {
                // Update the password in Firestore/IndexedDB
                await dbManager.resetPassword(accountId, newPassword);
                // Close modal and reset form
                const modal = bootstrap.Modal.getInstance(document.getElementById('resetPasswordModal'));
                modal.hide();
                form.reset();
                showToast('Password reset successfully');
            } catch (error) {
                console.error('Failed to reset password:', error);
                showToast('Failed to reset password: ' + error.message, 'error');
            }
        }

        async function toggleAccountStatus(accountId) {
            try {
                const account = await dbManager.getAccount(accountId);
                const newStatus = account.status === 'active' ? 'suspended' : 'active';
                
                await dbManager.updateAccount(accountId, { status: newStatus });
                loadAccounts();
                
                showToast(`Account ${newStatus === 'active' ? 'activated' : 'suspended'} successfully`);
            } catch (error) {
                console.error('Failed to toggle account status:', error);
                showToast('Failed to update account status', 'error');
            }
        }

        async function deleteAccount(accountId) {
            if (!confirm('Are you sure you want to delete this account? This action cannot be undone.')) {
                return;
            }
            
            try {
                await dbManager.deleteAccount(accountId);
                loadAccounts();
                showToast('Account deleted successfully');
            } catch (error) {
                console.error('Failed to delete account:', error);
                showToast('Failed to delete account', 'error');
            }
        }

        function filterAccounts() {
            // Get filter values
            const roleFilter = document.getElementById('roleFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const searchTerm = document.getElementById('searchAccount').value.toLowerCase();
            
            // If all filters are empty, reload all accounts
            if (!roleFilter && !statusFilter && !searchTerm) {
                if (typeof loadAccounts === 'function') {
                    loadAccounts();
                }
                return;
            }

            // Use the global accountsData from account-pagination.js
            let filtered = window._accountPagination && window._accountPagination.getAccountsData
                ? window._accountPagination.getAccountsData()
                : (window.accountsData || []);

            // Apply filters
            filtered = filtered.filter(account => {
                const role = (account.role || '').toLowerCase();
                const status = (account.status || '').toLowerCase();
                const username = (account.username || '').toLowerCase();
                const email = (account.email || '').toLowerCase();
                const roleMatch = !roleFilter || role.includes(roleFilter);
                const statusMatch = !statusFilter || status.includes(statusFilter);
                const searchMatch = !searchTerm || username.includes(searchTerm) || email.includes(searchTerm);
                return roleMatch && statusMatch && searchMatch;
            });

            // Sort by latest (createdAt descending)
            filtered = filtered.slice().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            // Re-render paginated table with filtered results
            if (window._accountPagination && window._accountPagination.renderAccountsPageWithData) {
                window._accountPagination.renderAccountsPageWithData(filtered);
            } else if (window.renderAccountsPageWithData) {
                window.renderAccountsPageWithData(filtered);
            } else {
                // fallback: update accountsData and re-render
                window.accountsData = filtered;
                if (window._accountPagination && window._accountPagination.renderAccountsPage) {
                    window._accountPagination.renderAccountsPage();
                }
            }
        }

        function resetFilters() {
            document.getElementById('roleFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('searchAccount').value = '';
            filterAccounts();
        }

        async function loadProperties() {
            try {
                const properties = await dbManager.getProperties();
                const propertiesList = document.getElementById('propertiesList');
                
                // Update stats
                document.getElementById('totalProperties').textContent = properties.length;
                document.getElementById('availableProperties').textContent = properties.filter(p => p.status === 'available').length;
                document.getElementById('occupiedProperties').textContent = properties.filter(p => p.status === 'occupied').length;
                
                propertiesList.innerHTML = properties.map(property => `
                    <tr>
                        <td>${property.name}</td>
                        <td><span class="badge bg-info">${property.type}</span></td>
                        <td><span class="badge ${property.status === 'available' ? 'bg-success' : 'bg-warning'}">${property.status}</span></td>
                        <td>${property.tenantId || 'None'}</td>
                        <td class="action-buttons">
                            <button onclick="editProperty('${property.id}')" class="btn btn-sm btn-primary">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button onclick="deleteProperty('${property.id}')" class="btn btn-sm btn-danger">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load properties:', error);
                alert('Failed to load properties. Please refresh the page.');
            }
        }

        async function loadMaintenanceRequests() {
            try {
                const requests = await dbManager.getComplaints();
                const maintenanceList = document.getElementById('maintenanceList');
                
                // Update stats
                document.getElementById('totalRequests').textContent = requests.length;
                document.getElementById('pendingRequests').textContent = requests.filter(r => r.status === 'pending').length;
                document.getElementById('completedRequests').textContent = requests.filter(r => r.status === 'completed').length;
                
                maintenanceList.innerHTML = requests.map(request => `
                    <tr>
                        <td>${new Date(request.createdAt).toLocaleDateString()}</td>
                        <td>${request.tenantId}</td>
                        <td>${request.description}</td>
                        <td><span class="badge ${getStatusBadgeClass(request.status)}">${request.status}</span></td>
                        <td class="action-buttons">
                            <button onclick="viewMaintenanceRequest('${request.id}')" class="btn btn-sm btn-info">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button onclick="updateMaintenanceStatus('${request.id}')" class="btn btn-sm btn-primary">
                                <i class="fas fa-edit"></i> Update
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load maintenance requests:', error);
                alert('Failed to load maintenance requests. Please refresh the page.');
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }
        
        // Function to manually sync data from Firestore to IndexedDB
        function syncWithFirestore() {
            const syncButton = document.getElementById('syncButton');
            syncButton.disabled = true;
            syncButton.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Syncing...';
            
            // Show loading spinner
            document.getElementById('loadingSpinner').classList.remove('d-none');
            
            // Call the fetchAllFromFirestore method to get data from Firestore
            if (window.firebaseSync) {
                window.firebaseSync.fetchAllFromFirestore()
                    .then(() => {
                        // Reload the data on the page
                        loadDashboardData();
                        loadAccounts();
                        
                        // Show success message
                        showToast('Data successfully synced from Firestore', 'success');
                    })
                    .catch(error => {
                        console.error('Error syncing data:', error);
                        showToast('Error syncing data from Firestore', 'error');
                    })
                    .finally(() => {
                        // Hide loading spinner
                        document.getElementById('loadingSpinner').classList.add('d-none');
                        // Reset button
                        syncButton.disabled = false;
                        syncButton.innerHTML = '<i class="fas fa-cloud-download-alt"></i> Sync Data';
                    });
            } else {
                showToast('Firebase sync not available', 'error');
                syncButton.disabled = false;
                syncButton.innerHTML = '<i class="fas fa-cloud-download-alt"></i> Sync Data';
                document.getElementById('loadingSpinner').classList.add('d-none');
            }
        }

        // Add smooth scrolling
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const targetId = this.getAttribute('href');
                if (targetId && targetId !== '#') {
                    const targetElement = document.querySelector(targetId);
                    if (targetElement) {
                        targetElement.scrollIntoView({
                    behavior: 'smooth'
                });
                    } else {
                        console.warn(`Smooth scroll target not found: ${targetId}`);
                    }
                }
            });
        });
            
        // Add hover effects for cards
        document.querySelectorAll('.stat-card').forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-5px)';
            });
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });
        });

        async function loadDashboardData() {
            showLoading();
            try {
                // Load available apartments from listing page
                const apartments = await dbManager.getAvailableApartments();
                const availableApartmentsCount = apartments.length;
                document.getElementById('availableApartments').textContent = availableApartmentsCount;
                
                // Calculate trend (comparing with last month's data)
                const lastMonthApartments = await dbManager.getLastMonthAvailableApartments();
                const trend = calculateTrend(availableApartmentsCount, lastMonthApartments.length);
                document.getElementById('apartmentTrend').textContent = `${trend}% from last month`;

                // Load latest payments
                const payments = await dbManager.getPayments();
                const latestPaymentsList = document.getElementById('latestPaymentsList');
                latestPaymentsList.innerHTML = payments.slice(0, 5).map(payment => `
                    <tr>
                        <td>${payment.tenantName}</td>
                        <td>₱${payment.amount}</td>
                        <td>${new Date(payment.date).toLocaleDateString()}</td>
                        <td><span class="badge ${payment.status === 'completed' ? 'bg-success' : 'bg-warning'}">${payment.status}</span></td>
                    </tr>
                `).join('');

                // Load upcoming events
                const events = await dbManager.getEvents();
                const upcomingEventsList = document.getElementById('upcomingEventsList');
                upcomingEventsList.innerHTML = events.slice(0, 5).map(event => `
                    <tr>
                        <td>${event.name}</td>
                        <td>${new Date(event.date).toLocaleDateString()}</td>
                        <td>${event.location}</td>
                        <td><span class="badge ${event.status === 'confirmed' ? 'bg-success' : 'bg-warning'}">${event.status}</span></td>
                    </tr>
                `).join('');

                // Update statistics
                document.getElementById('totalBookings').textContent = events.length;
                
                // Update notifications
                const pendingMaintenance = await dbManager.getComplaints();
                const pendingPayments = payments.filter(p => p.status === 'pending');
                const pendingEvents = events.filter(e => e.status === 'pending');
                
                const notificationList = document.querySelector('.alert-info ul');
                notificationList.innerHTML = `
                    <li>${pendingMaintenance.length} new maintenance requests pending</li>
                    <li>${pendingPayments.length} upcoming rent payments due tomorrow</li>
                    <li>${pendingEvents.length} new event booking requests</li>
                `;

                // Initialize charts
                initializeCharts(payments, events);
                
                showToast('Dashboard data loaded successfully');
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
                showToast('Failed to load dashboard data', 'error');
            } finally {
                hideLoading();
            }
        }

        function initializeCharts(payments, events) {
            // Revenue Chart
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Monthly Revenue',
                        data: [12000, 19000, 15000, 25000, 22000, 30000],
                        borderColor: '#6366f1',
                        tension: 0.4,
                        fill: true,
                        backgroundColor: 'rgba(99, 102, 241, 0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                display: true,
                                drawBorder: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            // Property Status Chart
            const propertyCtx = document.getElementById('propertyStatusChart').getContext('2d');
            new Chart(propertyCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Occupied', 'Available', 'Maintenance'],
                    datasets: [{
                        data: [65, 25, 10],
                        backgroundColor: [
                            '#10b981',
                            '#6366f1',
                            '#f59e0b'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Helper function to calculate trend percentage
        function calculateTrend(current, previous) {
            if (previous === 0) return 100;
            const difference = current - previous;
            const percentage = (difference / previous) * 100;
            return Math.round(percentage);
        }

        // Payment History Functions
        async function loadPaymentHistory() {
            showLoading();
            try {
                console.log('Loading payment history...');
                const payments = await paymentHistoryDB.getAllPayments();
                console.log('Payments loaded:', payments);
                // Fetch accounts and listings for mapping unit details
                const [accounts, listings] = await Promise.all([
                    dbManager.getAllAccounts(),
                    dbManager.getAllListings()
                ]);
                // Attach unitCell to each payment
                const enrichedPayments = payments.map(payment => {
                    let unitCell = '<span class="text-muted">-</span>';
                    const account = accounts.find(acc => acc.id === payment.tenantId);
                    if (account && account.unitId) {
                        const unit = listings.find(l => l.id === account.unitId);
                        if (unit) {
                            unitCell = `<div><strong>${unit.title || unit.id}</strong>${unit.area ? ` (${unit.area} sqm)` : ''}</div>`;
                        } else {
                            unitCell = '<span class="text-muted">Not found</span>';
                        }
                    }
                    return { ...payment, unitCell };
                });
                // Calculate statistics and trends
                const stats = calculatePaymentStats(payments);
                // Update statistics display
                updatePaymentStats(stats);
                // Render payments table with enriched data
                window.renderPaymentsTable(enrichedPayments);
                showToast('Payment history loaded successfully');
            } catch (error) {
                console.error('Failed to load payment history:', error);
                showToast('Failed to load payment history: ' + (error.message || 'Unknown error'), 'error');
                showErrorState();
            } finally {
                hideLoading();
            }
        }

        function calculatePaymentStats(payments) {
            const now = new Date();
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            
            const currentMonthPayments = payments.filter(p => new Date(p.date) >= lastMonth);
            const previousMonthPayments = payments.filter(p => {
                const date = new Date(p.date);
                return date >= new Date(lastMonth.getFullYear(), lastMonth.getMonth() - 1, 1) && date < lastMonth;
            });
            
            return {
                total: {
                    count: payments.length,
                    trend: calculateTrend(
                        currentMonthPayments.length,
                        previousMonthPayments.length
                    )
                },
                completed: {
                    count: payments.filter(p => p.status === 'completed').length,
                    trend: calculateTrend(
                        currentMonthPayments.filter(p => p.status === 'completed').length,
                        previousMonthPayments.filter(p => p.status === 'completed').length
                    )
                },
                pending: {
                    count: payments.filter(p => p.status === 'pending').length,
                    trend: calculateTrend(
                        currentMonthPayments.filter(p => p.status === 'pending').length,
                        previousMonthPayments.filter(p => p.status === 'pending').length
                    )
                },
                failed: {
                    count: payments.filter(p => p.status === 'failed').length,
                    trend: calculateTrend(
                        currentMonthPayments.filter(p => p.status === 'failed').length,
                        previousMonthPayments.filter(p => p.status === 'failed').length
                    )
                }
            };
        }

        function updatePaymentStats(stats) {
            document.getElementById('total-payments').textContent = stats.total.count;
            document.getElementById('completed-payments').textContent = stats.completed.count;
            document.getElementById('pending-payments').textContent = stats.pending.count;
            document.getElementById('failed-payments').textContent = stats.failed.count;
            
            document.getElementById('total-trend').textContent = `${stats.total.trend}% from last month`;
            document.getElementById('completed-trend').textContent = `${stats.completed.trend}% from last month`;
            document.getElementById('pending-trend').textContent = `${stats.pending.trend}% from last month`;
            document.getElementById('failed-trend').textContent = `${stats.failed.trend}% from last month`;
        }

        function showErrorState() {
            const paymentsTableBody = document.getElementById('payments-table-body');
            paymentsTableBody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4 text-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Failed to load payment history. Please try again.
                    </td>
                </tr>
            `;
        }

        function getPaymentMethodIcon(method) {
            switch (method) {
                case 'credit_card': return 'fa-credit-card';
                case 'bank_transfer': return 'fa-university';
                case 'cash': return 'fa-money-bill';
                default: return 'fa-money-bill';
            }
        }

        function formatPaymentMethod(method) {
            return method.split('_').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        function getPaymentStatusIcon(status) {
            switch (status) {
                case 'completed': return 'fa-check-circle';
                case 'pending': return 'fa-clock';
                case 'failed': return 'fa-times-circle';
                default: return 'fa-question-circle';
            }
        }

        async function filterPayments() {
            const status = document.getElementById('paymentStatusFilter').value;
            const method = document.getElementById('paymentMethodFilter').value;
            const startDate = document.getElementById('paymentDateStart').value;
            const endDate = document.getElementById('paymentDateEnd').value;
            
            showLoading();
            try {
                let payments;
                
                if (startDate && endDate) {
                    payments = await paymentHistoryDB.getPaymentsByDateRange(startDate, endDate);
                } else {
                    payments = await paymentHistoryDB.getAllPayments();
                }
                
                // Apply filters
                payments = payments.filter(payment => {
                    const statusMatch = !status || payment.status === status;
                    const methodMatch = !method || payment.paymentMethod === method;
                    return statusMatch && methodMatch;
                });
                
                // Update table
                const paymentHistoryList = document.getElementById('paymentHistoryList');
                paymentHistoryList.innerHTML = payments.map(payment => `
                    <tr class="payment-card" data-status="${payment.status}">
                        <td data-label="Date">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-calendar me-2 text-muted"></i>
                                ${new Date(payment.date).toLocaleDateString()}
                            </div>
                        </td>
                        <td data-label="Tenant">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-user me-2 text-muted"></i>
                                ${payment.username || payment.tenantId}
                            </div>
                        </td>
                        <td data-label="Amount">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-coins me-2 text-muted"></i>
                                ₱${payment.amount.toLocaleString()}
                            </div>
                        </td>
                        <td data-label="Payment Method">
                            <div class="payment-method-indicator ${payment.paymentMethod}">
                                <i class="fas ${getPaymentMethodIcon(payment.paymentMethod)}"></i>
                                ${formatPaymentMethod(payment.paymentMethod)}
                            </div>
                        </td>
                        <td data-label="Status">
                            <div class="status-indicator ${payment.status}">
                                <i class="fas ${getPaymentStatusIcon(payment.status)}"></i>
                                ${payment.status}
                            </div>
                        </td>
                        <td data-label="Recorded By">${payment.recordedByUsername || '<span class="text-muted">-</span>'}</td>
                        <td data-label="Actions">
                            <div class="action-buttons">
                                <button onclick="viewPaymentDetails('${payment.id}')" class="btn btn-sm btn-info" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="updatePaymentStatus('${payment.id}')" class="btn btn-sm btn-warning" title="Update Status">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deletePayment('${payment.id}')" class="btn btn-sm btn-danger" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
                
                showToast('Payments filtered successfully');
            } catch (error) {
                console.error('Failed to filter payments:', error);
                showToast('Failed to filter payments', 'error');
            } finally {
                hideLoading();
            }
        }

        async function viewPaymentDetails(paymentId) {
            try {
                const payment = await paymentHistoryDB.getPayment(paymentId);
                if (!payment) {
                    showToast('Payment not found', 'error');
                    return;
                }
                
                // Show payment details in a modal
                const modal = new bootstrap.Modal(document.getElementById('paymentDetailsModal'));
                document.getElementById('paymentDetailsContent').innerHTML = `
                    <div class="payment-details">
                        <div class="detail-item">
                            <label>Payment ID:</label>
                            <span>${payment.id}</span>
                        </div>
                        <div class="detail-item">
                            <label>Tenant ID:</label>
                            <span>${payment.tenantId}</span>
                        </div>
                        <div class="detail-item">
                            <label>Amount:</label>
                            <span>₱${payment.amount.toLocaleString()}</span>
                        </div>
                        <div class="detail-item">
                            <label>Payment Method:</label>
                            <span>${formatPaymentMethod(payment.paymentMethod)}</span>
                        </div>
                        <div class="detail-item">
                            <label>Status:</label>
                            <span class="status-indicator ${payment.status}">${payment.status}</span>
                        </div>
                        <div class="detail-item">
                            <label>Date:</label>
                            <span>${new Date(payment.date).toLocaleString()}</span>
                        </div>
                        <div class="detail-item">
                            <label>Description:</label>
                            <span>${payment.description || 'N/A'}</span>
                        </div>
                    </div>
                `;
                modal.show();
            } catch (error) {
                console.error('Failed to load payment details:', error);
                showToast('Failed to load payment details', 'error');
            }
        }

        async function updatePaymentStatus(paymentId) {
            try {
                const payment = await paymentHistoryDB.getPayment(paymentId);
                if (!payment) {
                    showToast('Payment not found', 'error');
                    return;
                }
                
                // Show status update modal
                const modal = new bootstrap.Modal(document.getElementById('updatePaymentStatusModal'));
                document.getElementById('updatePaymentId').value = paymentId;
                document.getElementById('currentPaymentStatus').textContent = payment.status;
                modal.show();
            } catch (error) {
                console.error('Failed to load payment for update:', error);
                showToast('Failed to load payment details', 'error');
            }
        }

        async function submitPaymentStatusUpdate(event) {
            event.preventDefault();
            
            const paymentId = document.getElementById('updatePaymentId').value;
            const newStatus = document.getElementById('newPaymentStatus').value;
            
            try {
                await paymentHistoryDB.updatePayment(paymentId, { status: newStatus });
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('updatePaymentStatusModal'));
                modal.hide();
                
                // Reload payment history
                loadPaymentHistory();
                
                showToast('Payment status updated successfully');
            } catch (error) {
                console.error('Failed to update payment status:', error);
                showToast('Failed to update payment status', 'error');
            }
        }

        async function deletePayment(paymentId) {
            if (!confirm('Are you sure you want to delete this payment record? This action cannot be undone.')) {
                return;
            }
            
            try {
                await paymentHistoryDB.deletePayment(paymentId);
                loadPaymentHistory();
                showToast('Payment deleted successfully');
            } catch (error) {
                console.error('Failed to delete payment:', error);
                showToast('Failed to delete payment', 'error');
            }
        }

        async function exportPaymentHistory() {
            // Function removed
        }

        // Load tenant accounts for payment recording
        async function loadTenantAccounts() {
            try {
                const accounts = await dbManager.getAllAccounts();
                const tenants = accounts.filter(account => account.role === 'tenant');
                const select = document.getElementById('payment-tenant');
                select.innerHTML = '<option value="">Select Tenant</option>';
                
                tenants.forEach(tenant => {
                    const option = document.createElement('option');
                    option.value = tenant.id;
                    option.textContent = `${tenant.username} (${tenant.email})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading tenant accounts:', error);
                showToast('Error loading tenant accounts', 'error');
            }
        }

        // Show record payment modal
        function showRecordPaymentModal() {
            loadTenantAccounts();
            const modal = new bootstrap.Modal(document.getElementById('recordPaymentModal'));
            modal.show();
        }

        // Submit new payment
        async function submitPayment(event) {
            event.preventDefault();
            const form = document.getElementById('record-payment-form');
            const btn = document.getElementById('submit-payment-btn');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            showButtonLoading(btn);
            try {
                const tenantId = document.getElementById('payment-tenant').value;
                const month = document.getElementById('payment-month').value;
                const [year, monthNum] = month.split('-');
                const paymentDate = new Date(year, monthNum - 1, 1).toISOString();
                const tenantAccount = await dbManager.getAccount(tenantId);
                // Get the current user (admin/staff) who is recording the payment
                let currentUser = null;
                try {
                    currentUser = JSON.parse(localStorage.getItem('currentUser'));
                } catch (e) {}
                await paymentHistoryDB.addPayment({
                    tenantId,
                    username: tenantAccount && tenantAccount.username ? tenantAccount.username : '',
                    unitId: tenantAccount && tenantAccount.unitId ? tenantAccount.unitId : '',
                    amount: parseFloat(document.getElementById('payment-amount').value),
                    paymentMethod: document.getElementById('payment-method').value,
                    description: document.getElementById('payment-description').value,
                    date: paymentDate,
                    status: 'completed',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    recordedById: currentUser && currentUser.id ? currentUser.id : '',
                    recordedByUsername: currentUser && currentUser.username ? currentUser.username : ''
                });
                form.reset();
                bootstrap.Modal.getInstance(document.getElementById('recordPaymentModal')).hide();
                await loadPaymentHistory();
                showToast('Payment recorded successfully', 'success');
            } catch (error) {
                console.error('Error recording payment:', error);
                showToast('Error recording payment: ' + error.message, 'error');
            } finally {
                hideButtonLoading(btn);
            }
        }

        function resetPaymentFilters() {
            document.getElementById('payment-status-filter').value = '';
            document.getElementById('payment-method-filter').value = '';
            document.getElementById('payment-date-from').value = '';
            document.getElementById('payment-date-to').value = '';
            filterPayments();
        }

        async function checkExistingPayments() {
            const tenantId = document.getElementById('payment-tenant').value;
            const month = document.getElementById('payment-month').value;
            const warning = document.getElementById('existing-payment-warning');
            const submitBtn = document.getElementById('submit-payment-btn');
            
            if (!tenantId || !month) {
                warning.style.display = 'none';
                submitBtn.disabled = false;
                return;
            }

            try {
                const existingPayments = await paymentHistoryDB.getPaymentsByTenantAndMonth(tenantId, month);
                if (existingPayments.length > 0) {
                    warning.style.display = 'block';
                    submitBtn.disabled = true;
                } else {
                    warning.style.display = 'none';
                    submitBtn.disabled = false;
                }
            } catch (error) {
                console.error('Error checking existing payments:', error);
                showToast('Error checking existing payments', 'error');
            }
        }

        // Initialize listing database
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('Checking if listingDB is defined:', !!window.listingDB);
                
                if (!window.listingDB) {
                    console.error('listingDB is not defined globally. Check if js/listing-db-global.js is loaded correctly.');
                    showToast('Error: listingDB is not defined. Please check console for details.', 'error');
                    return;
                }
                
                // Initialize the database
                await window.listingDB.initialize();
                console.log('listingDB initialized successfully');
                
                // Initialize feature buttons functionality 
                setupFeatureButtons();
                
                // Load listing data
                await loadListings();
            } catch (error) {
                console.error('Failed to initialize listing database:', error);
                console.log('Error stack:', error.stack);
                showToast('Failed to initialize listing database: ' + (error.message || 'Unknown error'), 'error');
            }
        });

        // Load listings
        async function loadListings() {
            showLoading();
            try {
                console.log('Loading listings, listingDB:', listingDB);
                
                if (!listingDB) {
                    throw new Error('listingDB is not defined, check that js/listing-db-global.js is loaded correctly');
                }
                
                if (!listingDB.getAllListings) {
                    throw new Error('listingDB.getAllListings is not defined, check that the database is initialized properly');
                }
                
                const listings = await listingDB.getAllListings();
                console.log('Listings loaded:', listings);
                
                // Render listing cards in grid view
                window.renderListings(listings);
                
                // Setup filter button event listeners
                setupFilterButtons();
                
                // Setup search functionality
                setupSearchFunctionality(listings);
                
                hideLoading();
                showToast('Listings loaded successfully');
            } catch (error) {
                console.error('Failed to load listings:', error);
                console.log('Error stack:', error.stack);
                showToast('Failed to load listings: ' + (error.message || 'Unknown error'), 'error');
                hideLoading();
            }
        }
        
        // Setup filter buttons
        function setupFilterButtons() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    // Update active button state
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const filterValue = this.getAttribute('data-filter');
                    await filterListingsByStatus(filterValue);
                });
            });
        }
        
        // Filter listings by status
        async function filterListingsByStatus(status) {
            showLoading();
            try {
                let filteredListings;
                
                if (status === 'all') {
                    filteredListings = await listingDB.getAllListings();
                } else {
                    filteredListings = await listingDB.getListingsByStatus(status);
                }
                
                window.renderListings(filteredListings);
                hideLoading();
            } catch (error) {
                console.error('Failed to filter listings:', error);
                showToast('Failed to filter listings', 'error');
                hideLoading();
            }
        }
        
        // Setup search functionality
        function setupSearchFunctionality(allListings) {
            const searchInput = document.getElementById('listingSearch');
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const filtered = allListings.filter(listing => 
                    listing.title.toLowerCase().includes(searchTerm) ||
                    listing.location.toLowerCase().includes(searchTerm) ||
                    listing.description.toLowerCase().includes(searchTerm) ||
                    (listing.type && listing.type.toLowerCase().includes(searchTerm))
                );
                window.renderListings(filtered);
            });
        }

        // Helper function for status badge classes
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'available': return 'bg-success';
                case 'rented': return 'bg-warning';
                case 'maintenance': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        // Show add listing modal
        function showAddListingModal() {
            // Reset the form
            document.getElementById('listingForm').reset();
            
            // Reset feature buttons
            document.querySelectorAll('.feature-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Update the modal title
            document.getElementById('listingModalTitle').innerHTML = '<i class="fas fa-plus-circle me-2"></i>Add New Listing';
            
            // Clear the hidden ID field
            document.getElementById('listingId').value = '';
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('listingModal'));
            modal.show();
        }
        
        // Setup feature button handlers
        function setupFeatureButtons() {
            try {
                const featureButtons = document.querySelectorAll('.feature-btn');
                console.log('Setting up feature buttons:', featureButtons.length);
                
                featureButtons.forEach(btn => {
                    // Remove existing listeners by cloning
                    const newBtn = btn.cloneNode(true);
                    if (btn.parentNode) {
                        btn.parentNode.replaceChild(newBtn, btn);
                    }
                    
                    // Add new listener
                    newBtn.addEventListener('click', function() {
                        this.classList.toggle('selected');
                        updateFeatureInput();
                    });
                });
            } catch (error) {
                console.error('Error setting up feature buttons:', error);
            }
        }
        
        // Update hidden feature input from selected buttons
        function updateFeatureInput() {
            try {
                const selectedFeatures = [];
                const featureButtons = document.querySelectorAll('.feature-btn.selected');
                
                featureButtons.forEach(btn => {
                    const feature = btn.getAttribute('data-feature');
                    if (feature) {
                        selectedFeatures.push(feature);
                    }
                });
                
                const featureInput = document.getElementById('listingFeatures');
                if (featureInput) {
                    featureInput.value = selectedFeatures.join(',');
                }
                
                console.log('Selected features:', selectedFeatures);
            } catch (error) {
                console.error('Error updating feature input:', error);
            }
        }

        // Handle listing form submission
        async function handleListingSubmit(event) {
            event.preventDefault();
            try {
                updateFeatureInput();
                const listingId = document.getElementById('listingId').value;
                let area = document.getElementById('listingArea').value;
                area = area ? parseFloat(area) : null;
                let features = document.getElementById('listingFeatures').value;
                features = features ? features.split(',').filter(f => f.trim() !== '') : [];
                const listingData = {
                    title: document.getElementById('listingTitle').value,
                    type: document.getElementById('listingType').value || 'apartment',
                    price: parseFloat(document.getElementById('listingPrice').value) || 0,
                    status: document.getElementById('listingStatus').value || 'available',
                    description: document.getElementById('listingDescription').value || '',
                    area: area,
                    features: features,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                // Collect all image files from all inputs
                const imageInputs = document.querySelectorAll('#listingImagesContainer input[type="file"]');
                let imageFiles = [];
                imageInputs.forEach(input => {
                    if (input.files && input.files.length > 0) {
                        for (let i = 0; i < input.files.length; i++) {
                            imageFiles.push(input.files[i]);
                        }
                    }
                });
                // For add: start with empty array; for edit: use currentListingImages
                let imageUrls = listingId ? [...currentListingImages] : [];
                if (imageFiles.length > 0) {
                    for (let file of imageFiles) {
                        // Compress image
                        const compressedFile = await new Promise((resolve, reject) => {
                            new Compressor(file, {
                                quality: 0.7,
                                maxWidth: 1200,
                                maxHeight: 900,
                                success(result) { resolve(result); },
                                error(err) { reject(err); }
                            });
                        });
                        // Upload to Firebase Storage
                        const storageRef = firebase.storage().ref();
                        const fileName = `listings/${Date.now()}_${file.name}`;
                        const fileRef = storageRef.child(fileName);
                        await fileRef.put(compressedFile);
                        const downloadUrl = await fileRef.getDownloadURL();
                        imageUrls.push(downloadUrl);
                    }
                }
                if (imageUrls.length > 0) {
                    listingData.images = imageUrls;
                }
                if (listingId) {
                    await listingDB.updateListing(listingId, listingData);
                    showToast('Listing updated successfully');
                } else {
                    await listingDB.addListing(listingData);
                    showToast('Listing added successfully');
                }
                // Close modal and reload listings
                const modal = bootstrap.Modal.getInstance(document.getElementById('listingModal'));
                modal.hide();
                await loadListings();
            } catch (error) {
                console.error('Failed to save listing:', error);
                showToast('Failed to save listing: ' + (error.message || 'Unknown error'), 'error');
            }
        }

        // View listing details
        async function viewListing(id) {
            try {
                const listing = await listingDB.getListing(id);
                if (!listing) {
                    showToast('Listing not found', 'error');
                    return;
                }
                
                // Generate features HTML
                let featuresHtml = 'N/A';
                if (listing.features && listing.features.length > 0) {
                    featuresHtml = listing.features.map(feature => 
                        `<span class="badge">${feature}</span>`
                    ).join('');
                }
                // Status badge class
                const statusClass = {
                    available: 'bg-success',
                    rented: 'bg-warning',
                    maintenance: 'bg-danger',
                    pending: 'bg-info',
                    inactive: 'bg-secondary'
                }[listing.status] || 'bg-secondary';
                // Images
                const images = listing.images && listing.images.length > 0 ? listing.images : ["https://via.placeholder.com/600x400?text=No+Image"];
                // Modal content
                document.getElementById('listingDetailsContent').innerHTML = `
                    <div class="premium-listing-view">
                        <div class="premium-listing-image">
                            <img src="${images[0]}" alt="${listing.title}" class="premium-main-img" style="">
                            <button class="img-nav-btn left" aria-label="Previous image" style="left:12px;display:${images.length>1?'block':'none'}"><i class="fas fa-chevron-left"></i></button>
                            <button class="img-nav-btn right" aria-label="Next image" style="right:12px;display:${images.length>1?'block':'none'}"><i class="fas fa-chevron-right"></i></button>
                            <div class="listing-price-badge">₱${listing.price.toLocaleString()}</div>
                        </div>
                        <div class="premium-listing-info">
                            <div class="premium-listing-title">
                                ${listing.title}
                                <span class="premium-listing-status badge ${statusClass}">${formatStatus(listing.status)}</span>
                        </div>
                            <div class="premium-listing-details">
                                <span><i class="fas fa-home"></i> ${listing.type}</span>
                                <span><i class="fas fa-ruler-combined"></i> ${listing.area || 'N/A'} sq.m</span>
                        </div>
                            <div class="premium-listing-features">${featuresHtml}</div>
                            <div class="premium-listing-description">${listing.description || ''}</div>
                            <div class="premium-listing-meta">
                                <span><i class="fas fa-calendar-plus me-1"></i> Created: ${new Date(listing.createdAt).toLocaleString()}</span>
                                <span><i class="fas fa-calendar-alt me-1"></i> Updated: ${new Date(listing.updatedAt).toLocaleString()}</span>
                        </div>
                        </div>
                    </div>
                `;
                // Image navigation logic
                if (images.length > 1) {
                    const img = document.querySelector('#viewListingModal .premium-main-img');
                    const leftBtn = document.querySelector('#viewListingModal .img-nav-btn.left');
                    const rightBtn = document.querySelector('#viewListingModal .img-nav-btn.right');
                    let currentIndex = 0;
                    let isSliding = false;
                    function slideTo(newIndex, direction) {
                        if (isSliding) return;
                        isSliding = true;
                        img.style.transition = 'none';
                        img.style.transform = direction === 'left' ? 'translateX(-100%)' : 'translateX(100%)';
                        void img.offsetWidth;
                        img.src = images[newIndex];
                        img.style.transition = 'transform 0.7s cubic-bezier(0.85,0,0.15,1)';
                        img.style.transform = 'translateX(0)';
                        setTimeout(() => { isSliding = false; }, 700);
                    }
                    leftBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (isSliding) return;
                        const prevIndex = (currentIndex - 1 + images.length) % images.length;
                        slideTo(prevIndex, 'left');
                        currentIndex = prevIndex;
                    });
                    rightBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (isSliding) return;
                        const nextIndex = (currentIndex + 1) % images.length;
                        slideTo(nextIndex, 'right');
                        currentIndex = nextIndex;
                    });
                    // Swipe gesture for modal
                    let touchStartX = 0;
                    let touchEndX = 0;
                    img.addEventListener('touchstart', (e) => { touchStartX = e.changedTouches[0].screenX; });
                    img.addEventListener('touchmove', (e) => { touchEndX = e.changedTouches[0].screenX; });
                    img.addEventListener('touchend', (e) => {
                        if (isSliding) return;
                        const deltaX = touchEndX - touchStartX;
                        if (Math.abs(deltaX) > 50) {
                            if (deltaX < 0) {
                                const nextIndex = (currentIndex + 1) % images.length;
                                slideTo(nextIndex, 'right');
                                currentIndex = nextIndex;
                            } else {
                                const prevIndex = (currentIndex - 1 + images.length) % images.length;
                                slideTo(prevIndex, 'left');
                                currentIndex = prevIndex;
                            }
                        }
                        touchStartX = 0;
                        touchEndX = 0;
                    });
                }
                const modal = new bootstrap.Modal(document.getElementById('viewListingModal'));
                modal.show();
            } catch (error) {
                console.error('Failed to load listing details:', error);
                showToast('Failed to load listing details', 'error');
            }
        }

        // Edit listing
        async function editListing(id) {
            try {
                const listing = await listingDB.getListing(id);
                if (!listing) {
                    showToast('Listing not found', 'error');
                    return;
                }
                document.getElementById('listingModalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Edit Listing';
                document.getElementById('listingId').value = listing.id;
                document.getElementById('listingTitle').value = listing.title;
                document.getElementById('listingType').value = listing.type;
                document.getElementById('listingPrice').value = listing.price;
                document.getElementById('listingStatus').value = listing.status;
                document.getElementById('listingDescription').value = listing.description;
                document.getElementById('listingArea').value = listing.area || '';
                // Reset and select appropriate feature buttons
                document.querySelectorAll('.feature-btn').forEach(btn => {
                    const feature = btn.getAttribute('data-feature');
                    if (listing.features && listing.features.includes(feature)) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }
                });
                // Update hidden features input
                updateFeatureInput();
                // Initialize feature button handlers
                setupFeatureButtons();
                // Render current images with delete buttons
                const imgContainer = document.getElementById('listingImagesContainer');
                imgContainer.innerHTML = '';
                // Initialize the global array with current images
                currentListingImages = (listing.images && listing.images.length > 0) ? [...listing.images] : [];
                if (currentListingImages.length > 0) {
                    currentListingImages.forEach((imgUrl, idx) => {
                        const wrapper = document.createElement('div');
                        wrapper.style.position = 'relative';
                        wrapper.style.display = 'inline-block';
                        wrapper.style.marginRight = '8px';
                        wrapper.style.marginBottom = '8px';
                        const img = document.createElement('img');
                        img.src = imgUrl;
                        img.style.width = '80px';
                        img.style.height = '60px';
                        img.style.objectFit = 'cover';
                        img.style.borderRadius = '6px';
                        img.style.boxShadow = '0 1px 6px #0001';
                        img.style.border = '1.5px solid #e3e8ef';
                        img.setAttribute('data-img-url', imgUrl);
                        // Delete button
                        const delBtn = document.createElement('button');
                        delBtn.type = 'button';
                        delBtn.innerHTML = '<i class="fas fa-trash"></i>';
                        delBtn.title = 'Remove image';
                        delBtn.style.position = 'absolute';
                        delBtn.style.top = '2px';
                        delBtn.style.right = '2px';
                        delBtn.style.background = '#fff';
                        delBtn.style.color = '#e11d48';
                        delBtn.style.border = 'none';
                        delBtn.style.borderRadius = '50%';
                        delBtn.style.width = '24px';
                        delBtn.style.height = '24px';
                        delBtn.style.cursor = 'pointer';
                        delBtn.style.boxShadow = '0 1px 4px #0002';
                        delBtn.onclick = function() {
                            // Remove from DOM
                            wrapper.remove();
                            // Remove from the array
                            currentListingImages = currentListingImages.filter(url => url !== imgUrl);
                        };
                        wrapper.appendChild(img);
                        wrapper.appendChild(delBtn);
                        imgContainer.appendChild(wrapper);
                    });
                }
                // Add the file input for new uploads (support multiple)
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.className = 'form-control mb-2';
                fileInput.id = 'listingImages';
                fileInput.name = 'listingImages';
                fileInput.accept = 'image/*';
                fileInput.multiple = true;
                imgContainer.appendChild(fileInput);
                const modal = new bootstrap.Modal(document.getElementById('listingModal'));
                modal.show();
            } catch (error) {
                console.error('Failed to load listing for edit:', error);
                showToast('Failed to load listing details', 'error');
            }
        }

        // Delete listing
        async function deleteListing(id) {
            if (!confirm('Are you sure you want to delete this listing? This action cannot be undone.')) {
                return;
            }
            
            try {
                await listingDB.deleteListing(id);
                await loadListings();
                showToast('Listing deleted successfully');
            } catch (error) {
                console.error('Failed to delete listing:', error);
                showToast('Failed to delete listing', 'error');
            }
        }

        // Filter listings
        async function filterListings() {
            const type = document.getElementById('listingTypeFilter').value;
            const status = document.getElementById('listingStatusFilter').value;
            const minPrice = document.getElementById('minPrice').value;
            const maxPrice = document.getElementById('maxPrice').value;
            
            showLoading();
            try {
                let listings;
                
                if (type) {
                    listings = await listingDB.getListingsByType(type);
                } else if (status) {
                    listings = await listingDB.getListingsByStatus(status);
                } else if (minPrice && maxPrice) {
                    listings = await listingDB.getListingsByPriceRange(parseFloat(minPrice), parseFloat(maxPrice));
                } else {
                    listings = await listingDB.getAllListings();
                }
                
                window.renderListings(listings);
                showToast('Listings filtered successfully');
            } catch (error) {
                console.error('Failed to filter listings:', error);
                showToast('Failed to filter listings', 'error');
            } finally {
                hideLoading();
            }
        }

        // Reset listing filters
        function resetListingFilters() {
            document.getElementById('listingTypeFilter').value = '';
            document.getElementById('listingStatusFilter').value = '';
            document.getElementById('minPrice').value = '';
            document.getElementById('maxPrice').value = '';
            loadListings();
        }

        // Function to render listing cards
        function renderListings(listings) {
            const grid = document.getElementById('listingsGrid');
            grid.innerHTML = '';
            
            if (!listings || listings.length === 0) {
                grid.innerHTML = `
                    <div class="text-center py-5 w-100">
                        <i class="fas fa-info-circle fs-1 text-muted mb-3"></i>
                        <h4>No listings found</h4>
                        <p class="text-muted">Click on "Add New Listing" to create your first listing</p>
                    </div>
                `;
                return;
            }
            
            listings.forEach(listing => {
                const card = document.createElement('div');
                card.className = 'listing-card';
                card.setAttribute('data-status', listing.status);
                
                // Default image if none provided
                const imageSrc = listing.images && listing.images.length > 0 ? 
                    listing.images[0] : 'https://via.placeholder.com/400x300?text=Property+Image';
                
                // Format price with commas
                const formattedPrice = listing.price.toLocaleString();
                
                // Generate features html with better styling
                let featuresHtml = '';
                if (listing.features && listing.features.length > 0) {
                    featuresHtml = `
                        <div class="listing-features">
                            ${listing.features.slice(0, 3).map(feature => {
                                // Add appropriate icon for each feature
                                let icon = 'fa-check';
                                if (feature === 'WiFi') icon = 'fa-wifi';
                                if (feature === 'Parking') icon = 'fa-car';
                                if (feature === 'Pool') icon = 'fa-swimming-pool';
                                if (feature === 'AC') icon = 'fa-snowflake';
                                if (feature === 'Balcony') icon = 'fa-door-open';
                                if (feature === 'Gym') icon = 'fa-dumbbell';
                                if (feature === 'Security') icon = 'fa-shield-alt';
                                if (feature === 'Elevator') icon = 'fa-arrow-up';
                                if (feature === 'Furnished') icon = 'fa-couch';
                                
                                return `<span class="feature-tag"><i class="fas ${icon}"></i> ${feature}</span>`;
                            }).join('')}
                            ${listing.features.length > 3 ? 
                                `<span class="feature-tag"><i class="fas fa-plus"></i> ${listing.features.length - 3} more</span>` : ''}
                        </div>
                    `;
                }
                
                // Process description - sanitize and check length
                let descriptionHtml = '';
                if (listing.description) {
                    // Sanitize description to prevent XSS
                    const tempDiv = document.createElement('div');
                    tempDiv.textContent = listing.description;
                    const sanitizedDesc = tempDiv.innerHTML;
                    
                    // Create description element with proper classes for truncation
                    const isTruncated = sanitizedDesc.length > 150;
                    descriptionHtml = `
                        <div class="description-container">
                            <p class="listing-description ${isTruncated ? 'truncated' : ''}" 
                               title="${sanitizedDesc}">${sanitizedDesc}</p>
                            ${isTruncated ? 
                                `<button class="btn btn-sm btn-link p-0 mt-1 view-more-btn" 
                                 onclick="event.stopPropagation(); toggleDescription(this)">
                                 <i class="fas fa-chevron-down me-1"></i>View more
                                 </button>` : ''}
                        </div>
                    `;
                }
                
                // Get status icon based on status
                let statusIcon = 'fa-check-circle';
                if (listing.status === 'rented') statusIcon = 'fa-key';
                if (listing.status === 'maintenance') statusIcon = 'fa-tools';
                if (listing.status === 'pending') statusIcon = 'fa-clock';
                if (listing.status === 'inactive') statusIcon = 'fa-ban';
                
                // Generate HTML content for card
                card.innerHTML = `
                    <div class="listing-image position-relative" style="overflow:hidden;">
                        <img src="${imageSrc}" alt="${listing.title}" loading="lazy" class="listing-main-img img1" data-index="0" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:1;">
                        <img src="${imageSrc}" alt="${listing.title}" class="listing-main-img img2" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:0;opacity:0;pointer-events:none;">
                        <button class="img-nav-btn left" aria-label="Previous image" style="position:absolute;top:50%;left:8px;transform:translateY(-50%);z-index:3;background:rgba(255,255,255,0.8);border:none;border-radius:50%;width:32px;height:32px;display:${listing.images && listing.images.length > 1 ? 'block' : 'none'}"><i class="fas fa-chevron-left"></i></button>
                        <button class="img-nav-btn right" aria-label="Next image" style="position:absolute;top:50%;right:8px;transform:translateY(-50%);z-index:3;background:rgba(255,255,255,0.8);border:none;border-radius:50%;width:32px;height:32px;display:${listing.images && listing.images.length > 1 ? 'block' : 'none'}"><i class="fas fa-chevron-right"></i></button>
                        <div class="listing-price-badge" style="position:absolute;top:12px;right:12px;background:linear-gradient(90deg,#10b981,#22c55e);color:#fff;padding:0.5em 1.1em;border-radius:16px;font-weight:700;font-size:1.1em;box-shadow:0 2px 8px rgba(99,102,241,0.13);z-index:4;">₱${formattedPrice}</div>
                    </div>
                    <div class="listing-content">
                        <h3 class="listing-title">${listing.title}</h3>
                        <div class="listing-details">
                            <span class="listing-detail">
                                <i class="fas fa-home"></i>
                                ${listing.type}
                            </span>
                            <span class="listing-detail">
                                <i class="fas fa-ruler-combined"></i>
                                ${listing.area || 'N/A'} sq.m
                            </span>
                            <span class="listing-detail">
                                <i class="fas fa-calendar-alt"></i>
                                ${new Date(listing.updatedAt || new Date()).toLocaleDateString()}
                            </span>
                        </div>
                        <div class="listing-status status-${listing.status}">
                            <i class="fas ${statusIcon} mr-2"></i>
                            ${formatStatus(listing.status)}
                        </div>
                        ${descriptionHtml}
                        ${featuresHtml}
                        <div class="listing-actions">
                            <button class="action-btn view-btn" onclick="viewListing('${listing.id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="action-btn edit-btn" onclick="editListing('${listing.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteListing('${listing.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
                // ... existing code ...
                // After grid.appendChild(card), add this JS to handle image navigation:
                if (listing.images && listing.images.length > 1) {
                    const img1 = card.querySelector('.img1');
                    const img2 = card.querySelector('.img2');
                    let showingImg1 = true;
                    let currentIndex = 0;
                    const leftBtn = card.querySelector('.img-nav-btn.left');
                    const rightBtn = card.querySelector('.img-nav-btn.right');
                    let isSliding = false;
                    function slideTo(newIndex, direction) {
                      if (isSliding) return;
                      isSliding = true;
                      const [inImg, outImg] = showingImg1 ? [img2, img1] : [img1, img2];
                      inImg.src = listing.images[newIndex];
                      inImg.style.transition = outImg.style.transition = 'none';
                      inImg.style.opacity = 1;
                      inImg.style.zIndex = 2;
                      outImg.style.zIndex = 1;
                      // Set start positions
                      inImg.style.transform = direction === 'left' ? 'translateX(-100%)' : 'translateX(100%)';
                      outImg.style.transform = 'translateX(0)';
                      // Force reflow
                      void inImg.offsetWidth;
                      // Animate
                      inImg.style.transition = outImg.style.transition = 'transform 0.7s cubic-bezier(0.85,0,0.15,1)';
                      inImg.style.transform = 'translateX(0)';
                      outImg.style.transform = direction === 'left' ? 'translateX(100%)' : 'translateX(-100%)';
                      setTimeout(() => {
                        outImg.style.opacity = 0;
                        outImg.style.transform = 'translateX(0)';
                        inImg.style.opacity = 1;
                        showingImg1 = !showingImg1;
                        isSliding = false;
                      }, 700);
                      currentIndex = newIndex;
                    }
                    leftBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (isSliding) return;
                        const prevIndex = (currentIndex - 1 + listing.images.length) % listing.images.length;
                        slideTo(prevIndex, 'left');
                    });
                    rightBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (isSliding) return;
                        const nextIndex = (currentIndex + 1) % listing.images.length;
                        slideTo(nextIndex, 'right');
                    });
                    // Swipe gesture support for mobile
                    let touchStartX = 0;
                    let touchEndX = 0;
                    img1.addEventListener('touchstart', (e) => { touchStartX = e.changedTouches[0].screenX; });
                    img1.addEventListener('touchmove', (e) => { touchEndX = e.changedTouches[0].screenX; });
                    img1.addEventListener('touchend', (e) => {
                      if (isSliding) return;
                      const deltaX = touchEndX - touchStartX;
                      if (Math.abs(deltaX) > 50) {
                        if (deltaX < 0) {
                          const nextIndex = (currentIndex + 1) % listing.images.length;
                          slideTo(nextIndex, 'right');
                        } else {
                          const prevIndex = (currentIndex - 1 + listing.images.length) % listing.images.length;
                          slideTo(prevIndex, 'left');
                        }
                      }
                      touchStartX = 0;
                      touchEndX = 0;
                    });
                    img2.addEventListener('touchstart', (e) => { touchStartX = e.changedTouches[0].screenX; });
                    img2.addEventListener('touchmove', (e) => { touchEndX = e.changedTouches[0].screenX; });
                    img2.addEventListener('touchend', (e) => {
                      if (isSliding) return;
                      const deltaX = touchEndX - touchStartX;
                      if (Math.abs(deltaX) > 50) {
                        if (deltaX < 0) {
                          const nextIndex = (currentIndex + 1) % listing.images.length;
                          slideTo(nextIndex, 'right');
                        } else {
                          const prevIndex = (currentIndex - 1 + listing.images.length) % listing.images.length;
                          slideTo(prevIndex, 'left');
                        }
                      }
                      touchStartX = 0;
                      touchEndX = 0;
                    });
                }
                // ... existing code ...
            });
        }

        // Helper function to format listing status
        function formatStatus(status) {
            const statusMap = {
                'available': 'Available',
                'rented': 'Rented',
                'maintenance': 'Under Maintenance',
                'pending': 'Pending',
                'inactive': 'Inactive'
            };
            return statusMap[status] || status.charAt(0).toUpperCase() + status.slice(1);
        }

        // Save listing function
        function saveListing() {
            try {
                console.log('Save listing button clicked');
                
                // Get the form
                const listingForm = document.getElementById('listingForm');
                if (!listingForm) {
                    console.error('Listing form not found');
                    showToast('Error: Listing form not found', 'error');
                    return;
                }
                
                // Check validity
                if (!listingForm.checkValidity()) {
                    console.log('Form validation failed');
                    // Trigger form validation UI
                    listingForm.reportValidity();
                    return;
                }
                
                console.log('Form is valid, submitting');
                
                // Call the handler directly without synthetic event
                handleListingSubmit({
                    preventDefault: function() {} // Mock preventDefault
                });
                
            } catch (error) {
                console.error('Error in saveListing function:', error);
                showToast('Error saving listing: ' + (error.message || 'Unknown error'), 'error');
            }
        }

        // Add function to toggle description expansion
        function toggleDescription(button) {
            const container = button.parentElement;
            const description = container.querySelector('.listing-description');
            
            if (description.classList.contains('truncated')) {
                // Expand
                description.style.maxHeight = 'none';
                description.style.webkitLineClamp = 'unset';
                description.classList.remove('truncated');
                button.innerHTML = '<i class="fas fa-chevron-up me-1"></i>View less';
            } else {
                // Collapse
                description.style.maxHeight = '4.8rem';
                description.style.webkitLineClamp = '3';
                description.classList.add('truncated');
                button.innerHTML = '<i class="fas fa-chevron-down me-1"></i>View more';
            }
        }
    </script>

    <!-- Payment Details Modal -->
    <div class="modal fade" id="paymentDetailsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-info-circle me-2"></i>Payment Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="paymentDetailsContent">
                    <!-- Payment details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Update Payment Status Modal -->
    <div class="modal fade" id="updatePaymentStatusModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-edit me-2"></i>Update Payment Status
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="updatePaymentStatusForm" onsubmit="submitPaymentStatusUpdate(event)">
                        <input type="hidden" id="updatePaymentId">
                        <div class="mb-3">
                            <label class="form-label">Current Status</label>
                            <div id="currentPaymentStatus" class="form-control-plaintext"></div>
                        </div>
                        <div class="mb-3">
                            <label for="newPaymentStatus" class="form-label">New Status</label>
                            <select class="form-select" id="newPaymentStatus" required>
                                <option value="completed">Completed</option>
                                <option value="pending">Pending</option>
                                <option value="failed">Failed</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="statusUpdateReason" class="form-label">Reason for Update</label>
                            <textarea class="form-control" id="statusUpdateReason" rows="2" 
                                    placeholder="Enter reason for status update"></textarea>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-save me-2"></i>Update Status
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Record Payment Modal -->
    <div class="modal fade" id="recordPaymentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Record New Payment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="record-payment-form" onsubmit="submitPayment(event)">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="payment-tenant" class="form-label">Tenant</label>
                                <select class="form-select" id="payment-tenant" required onchange="checkExistingPayments()">
                                    <option value="">Select Tenant</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="payment-month" class="form-label">Payment Month</label>
                                <input type="month" class="form-control" id="payment-month" required onchange="checkExistingPayments()">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="payment-amount" class="form-label">Amount</label>
                                <div class="input-group">
                                    <span class="input-group-text">₱</span>
                                    <input type="number" class="form-control" id="payment-amount" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="payment-method" class="form-label">Payment Method</label>
                                <select class="form-select" id="payment-method" required>
                                    <option value="">Select Method</option>
                                    <option value="cash">Cash</option>
                                    <option value="bank_transfer">Bank Transfer</option>
                                    <option value="credit_card">Credit Card</option>
                                    <option value="check">Check</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="payment-description" class="form-label">Description</label>
                            <textarea class="form-control" id="payment-description" rows="3"></textarea>
                        </div>
                        <div class="alert alert-warning" id="existing-payment-warning" style="display: none;">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            A payment for this month already exists for the selected tenant.
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary" id="submit-payment-btn">Record Payment</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Booking Modal -->
    <div class="modal fade" id="createBookingModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-calendar-plus me-2"></i>Create New Booking
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="create-booking-form" onsubmit="submitBooking(event)">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Property</label>
                                <select class="form-select" id="booking-property" required>
                                    <option value="">Select Property</option>
                                    <!-- Properties will be populated here -->
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Booking Date</label>
                                <input type="date" class="form-control" id="booking-date" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Booking Time</label>
                                <input type="time" class="form-control" id="booking-time" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="booking-status" required>
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="completed">Completed</option>
                                    <option value="canceled">Canceled</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Contact Name</label>
                                <input type="text" class="form-control" id="booking-name" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Contact Phone</label>
                                <input type="tel" class="form-control" id="booking-phone" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" id="booking-notes" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end mt-4">
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Create Booking
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Booking Modal -->
    <div class="modal fade" id="editBookingModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-edit me-2"></i>Edit Booking
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-booking-form" onsubmit="updateBookingSubmit(event)">
                        <input type="hidden" id="edit-booking-id">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Property</label>
                                <select class="form-select" id="edit-booking-property" required>
                                    <option value="">Select Property</option>
                                    <!-- Properties will be populated here -->
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Booking Date</label>
                                <input type="date" class="form-control" id="edit-booking-date" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Booking Time</label>
                                <input type="time" class="form-control" id="edit-booking-time" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="edit-booking-status" required>
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="completed">Completed</option>
                                    <option value="canceled">Canceled</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Contact Name</label>
                                <input type="text" class="form-control" id="edit-booking-name" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Contact Phone</label>
                                <input type="tel" class="form-control" id="edit-booking-phone" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" id="edit-booking-notes" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end mt-4">
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Update Booking
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- View Booking Modal -->
    <div class="modal fade" id="viewBookingModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-calendar-check me-2"></i>Booking Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="booking-details-content">
                    <!-- Booking details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="edit-booking-btn">
                        <i class="fas fa-edit me-2"></i>Edit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Other scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ... existing code ...

        // ============ COMPLAINTS MANAGEMENT FUNCTIONS ============
        
        // Current complaint being viewed in detail modal
        let currentComplaint = null;
        let complaintCharts = {};
        let complaintView = 'table'; // Default view

        // Toggle between table and dashboard view
        function toggleComplaintView(viewType) {
            complaintView = viewType;
            if (viewType === 'table') {
                document.getElementById('complaint-table-view').style.display = 'block';
                document.getElementById('complaint-dashboard-view').style.display = 'none';
                // Show filter and personnel list
                const filterCard = document.getElementById('complaints-filter-card');
                if (filterCard) filterCard.style.display = '';
                const regBtn = document.getElementById('registerPersonnelBtn')?.parentElement;
                if (regBtn) regBtn.style.display = '';
                const personnelTable = document.getElementById('personnelTableCard');
                if (personnelTable) personnelTable.style.display = '';
            } else {
                document.getElementById('complaint-table-view').style.display = 'none';
                document.getElementById('complaint-dashboard-view').style.display = 'block';
                // Hide filter and personnel list
                const filterCard = document.getElementById('complaints-filter-card');
                if (filterCard) filterCard.style.display = 'none';
                const regBtn = document.getElementById('registerPersonnelBtn')?.parentElement;
                if (regBtn) regBtn.style.display = 'none';
                const personnelTable = document.getElementById('personnelTableCard');
                if (personnelTable) personnelTable.style.display = 'none';
                // Always fetch latest complaints and re-render charts
                renderComplaintDashboardCharts();
            }
        }

        // Render complaint dashboard charts with latest data
        async function renderComplaintDashboardCharts() {
            try {
                const complaints = await fetchComplaintsFromFirestore();
                // Calculate stats
                const stats = {
                    byCategory: {},
                    byStatus: { pending: 0, assigned: 0, inProgress: 0, completed: 0 },
                    byUrgency: { High: 0, Medium: 0, Low: 0 },
                    byLanguage: { english: 0, tagalog: 0 }
                };
                complaints.forEach(c => {
                    // Category
                    const cat = c.categoryLabel || getCategoryLabel(c.category) || 'Uncategorized';
                    stats.byCategory[cat] = (stats.byCategory[cat] || 0) + 1;
                    // Status
                    if (c.status === 'pending') stats.byStatus.pending++;
                    else if (c.status === 'assigned') stats.byStatus.assigned++;
                    else if (c.status === 'in_progress') stats.byStatus.inProgress++;
                    else if (c.status === 'completed') stats.byStatus.completed++;
                    // Urgency
                    if (c.urgency === 'High') stats.byUrgency.High++;
                    else if (c.urgency === 'Medium') stats.byUrgency.Medium++;
                    else stats.byUrgency.Low++;
                    // Language (simple heuristic: if description contains only a-z, assume english)
                    if (c.description && /^[a-zA-Z0-9\s.,!?]+$/.test(c.description)) stats.byLanguage.english++;
                    else stats.byLanguage.tagalog++;
                });
                // Destroy old charts if they exist
                if (window.complaintCharts) {
                    Object.values(window.complaintCharts).forEach(chart => { try { chart.destroy(); } catch {} });
                        }
                window.complaintCharts = {};
                // Category chart
                const categoryCtx = document.getElementById('complaint-category-chart').getContext('2d');
                window.complaintCharts.categoryChart = new Chart(categoryCtx, {
                        type: 'pie',
                        data: {
                        labels: Object.keys(stats.byCategory),
                            datasets: [{
                            data: Object.values(stats.byCategory),
                            backgroundColor: ['#4F46E5', '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#6B7280']
                            }]
                        },
                    options: { responsive: true, maintainAspectRatio: false }
                    });
                // Status chart
                    const statusCtx = document.getElementById('complaint-status-chart').getContext('2d');
                window.complaintCharts.statusChart = new Chart(statusCtx, {
                        type: 'bar',
                        data: {
                            labels: ['Pending', 'Assigned', 'In Progress', 'Completed'],
                            datasets: [{
                                label: 'Number of Complaints',
                            data: [stats.byStatus.pending, stats.byStatus.assigned, stats.byStatus.inProgress, stats.byStatus.completed],
                            backgroundColor: ['#F59E0B', '#3B82F6', '#8B5CF6', '#10B981']
                            }]
                        },
                    options: { responsive: true, maintainAspectRatio: false }
                    });
                // Urgency chart
                    const urgencyCtx = document.getElementById('complaint-urgency-chart').getContext('2d');
                window.complaintCharts.urgencyChart = new Chart(urgencyCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['High', 'Medium', 'Low'],
                            datasets: [{
                            data: [stats.byUrgency.High, stats.byUrgency.Medium, stats.byUrgency.Low],
                            backgroundColor: ['#EF4444', '#F59E0B', '#3B82F6']
                            }]
                        },
                    options: { responsive: true, maintainAspectRatio: false }
                    });
                // Language chart
                    const languageCtx = document.getElementById('complaint-language-chart').getContext('2d');
                window.complaintCharts.languageChart = new Chart(languageCtx, {
                        type: 'pie',
                        data: {
                            labels: ['English', 'Tagalog'],
                            datasets: [{
                            data: [stats.byLanguage.english, stats.byLanguage.tagalog],
                            backgroundColor: ['#6366F1', '#8B5CF6']
                            }]
                        },
                    options: { responsive: true, maintainAspectRatio: false }
                });
                // Complaint Trend & Prediction chart
                const trendPredictionCtx = document.getElementById('complaint-trend-prediction-chart').getContext('2d');
                window.complaintCharts.trendPredictionChart = new Chart(trendPredictionCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        datasets: [{
                            label: 'Complaints Trend',
                            data: [10, 20, 15, 25, 20, 30],
                            borderColor: '#6366f1',
                            tension: 0.4,
                            fill: true,
                            backgroundColor: 'rgba(99, 102, 241, 0.1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    display: true,
                                    drawBorder: false
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
                // Resolution Rate chart
                const resolutionRateCtx = document.getElementById('complaint-resolution-rate-chart').getContext('2d');
                window.complaintCharts.resolutionRateChart = new Chart(resolutionRateCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Resolved', 'Unresolved'],
                        datasets: [{
                            data: [stats.byStatus.completed, stats.byStatus.pending],
                            backgroundColor: ['#10b981', '#f59e0b'],
                            borderColor: ['#ffffff'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
                // In renderComplaintDashboardCharts, after fetching complaints and before/after other chart rendering:
                renderComplaintAnalytics(complaints);
            } catch (error) {
                showToast('Failed to render complaint dashboard', 'error');
                }
        }

        // Load all complaints from the database
        async function loadComplaints() {
            try {
                console.log('Loading complaints...');
                
                // Check if complaintManager is available
                if (!complaintManager) {
                    console.error('complaintManager is not defined!');
                    showToast('Complaint manager not loaded correctly. Please refresh the page.', 'error');
                    return;
                }
                
                // Display loading indicator
                document.getElementById('complaintsList').innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Loading complaints...</p>
                        </td>
                    </tr>
                `;
                
                // Ensure dbManager is initialized
                if (!dbManager.initialized) {
                    console.log('Waiting for dbManager initialization...');
                    await dbManager.initialize();
                }
                
                // Get all complaints with direct db access as a fallback
                let complaints = [];
                try {
                    complaints = await dbManager.getComplaints();
                    console.log('Complaints loaded:', complaints);
                } catch (err) {
                    console.error('Error loading complaints from DB:', err);
                }
                
                // Update statistics
                updateComplaintStatistics(complaints);
                
                // Normalize createdAt to ISO string for all complaints
                complaints.forEach(c => {
                    if (c.createdAt && typeof c.createdAt.toDate === 'function') {
                        c.createdAt = c.createdAt.toDate().toISOString();
                    } else if (c.createdAt && typeof c.createdAt === 'number') {
                        c.createdAt = new Date(c.createdAt).toISOString();
                    }
                });
                // Sort by latest (createdAt descending)
                complaints = complaints.slice().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                console.log('Sorted complaints:', complaints.map(c => c.createdAt));
                // Render complaints in table with pagination
                if (window._complaintPagination && typeof window._complaintPagination.renderComplaintsPageWithData === 'function') {
                    window._complaintPagination.renderComplaintsPageWithData(complaints);
                } else {
                renderComplaintsTable(complaints);
                }
                
                // If dashboard view is active, refresh charts
                if (complaintView === 'dashboard') {
                    renderComplaintAnalytics(complaints);
                }
            } catch (error) {
                console.error('Error loading complaints:', error);
                showToast('Failed to load complaints: ' + (error.message || 'Unknown error'), 'error');
                
                // Show error in the table
                document.getElementById('complaintsList').innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Error loading complaints. Please try again.
                        </td>
                    </tr>
                `;
            }
        }

        // Filter complaints based on selected criteria
        async function filterComplaints() {
            try {
                const filters = {
                    status: document.getElementById('complaint-status-filter').value,
                    category: document.getElementById('complaint-category-filter').value,
                    urgency: document.getElementById('complaint-urgency-filter').value,
                    searchText: document.getElementById('complaint-search-filter').value,
                    startDate: document.getElementById('complaint-date-from').value,
                    endDate: document.getElementById('complaint-date-to').value
                };
                // Get filtered complaints
                let complaints = await complaintManager.getComplaints(filters);
                // Normalize createdAt to ISO string for all complaints
                complaints.forEach(c => {
                    if (c.createdAt && typeof c.createdAt.toDate === 'function') {
                        c.createdAt = c.createdAt.toDate().toISOString();
                    } else if (c.createdAt && typeof c.createdAt === 'number') {
                        c.createdAt = new Date(c.createdAt).toISOString();
                    }
                });
                // Sort by latest (createdAt descending)
                complaints = complaints.slice().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                console.log('Sorted complaints:', complaints.map(c => c.createdAt));
                // Render filtered complaints with pagination
                if (window._complaintPagination && typeof window._complaintPagination.renderComplaintsPageWithData === 'function') {
                    window._complaintPagination.renderComplaintsPageWithData(complaints);
                } else {
                renderComplaintsTable(complaints);
                }
                // Show message about filter results
                showToast(`Showing ${complaints.length} filtered complaints`);
            } catch (error) {
                console.error('Error filtering complaints:', error);
                showToast('Failed to filter complaints', 'error');
            }
        }

        // Reset complaint filters
        function resetComplaintFilters() {
            document.getElementById('complaint-status-filter').value = '';
            document.getElementById('complaint-category-filter').value = '';
            document.getElementById('complaint-urgency-filter').value = '';
            document.getElementById('complaint-search-filter').value = '';
            document.getElementById('complaint-date-from').value = '';
            document.getElementById('complaint-date-to').value = '';
            
            // Reload all complaints
            loadComplaints();
        }

        // Render complaints in the table
        function renderComplaintsTable(complaints) {
            const complaintsList = document.getElementById('complaintsList');
            if (complaints.length === 0) {
                complaintsList.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4 text-muted">
                            <i class="fas fa-inbox me-2"></i>No complaints found
                        </td>
                    </tr>
                `;
                return;
            }
            complaintsList.innerHTML = complaints.map(complaint => {
                // Defensive: fallback for missing fields
                const description = typeof complaint.description === 'string' ? complaint.description : '';
                const createdAt = complaint.createdAt ? new Date(complaint.createdAt).toLocaleDateString() : '-';
                const tenantId = complaint.tenantId || '-';
                const category = complaint.categoryLabel || getCategoryLabel(complaint.category) || 'Uncategorized';
                const location = complaint.location || 'Unspecified';
                const urgency = complaint.urgencyLabel || complaint.urgency || 'Low';
                const status = complaint.status || 'pending';
                // NEW: Unit column logic
                let unitCell = '<span class="text-muted">-</span>';
                if (complaint.unitId && window.allListings) {
                    const unit = window.allListings.find(l => l.id === complaint.unitId);
                    if (unit) {
                        unitCell = `<div><strong>${unit.title || unit.id}</strong>${unit.area ? ` (${unit.area} sqm)` : ''}</div>`;
                    } else {
                        unitCell = '<span class="text-muted">Not found</span>';
                    }
                } else if (complaint.unitName) {
                    unitCell = `<div><strong>${complaint.unitName}</strong></div>`;
                }
                // Mobile info
                const mobileInfo = `
                    <div class="d-md-none mt-2">
                        <span class="badge bg-primary me-1">${category}</span>
                        <span class="badge bg-secondary me-1">${location}</span>
                        <span class="badge ${getUrgencyBadgeClass(complaint.urgency)}">${urgency}</span>
                    </div>
                `;
                return `
                    <tr>
                        <td>${createdAt}</td>
                        <td>${tenantId}</td>
                        <td>
                            <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">
                                ${description.length > 60 ? description.substring(0, 60) + '...' : description}
                            </div>
                            ${mobileInfo}
                        </td>
                        <td class="d-none d-md-table-cell"><span class="badge bg-primary">${category}</span></td>
                        <td class="d-none d-md-table-cell">${unitCell}</td> <!-- NEW COLUMN -->
                        <td class="d-none d-md-table-cell">${location}</td>
                        <td class="d-none d-md-table-cell"><span class="badge ${getUrgencyBadgeClass(complaint.urgency)}">${urgency}</span></td>
                        <td><span class="badge ${getStatusBadgeClass(status)}">${getStatusLabel(status)}</span></td>
                        <td>
                            <div class="d-flex flex-row align-items-center gap-1 justify-content-center" style="min-width:110px;">
                                <button class="btn btn-sm btn-secondary px-2 py-1" title="View Details" onclick="showComplaintDetails('${complaint.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning px-2 py-1" title="Mark In Progress" onclick="markComplaintInProgress('${complaint.id}')">
                                    <i class="fas fa-tools"></i>
                                </button>
                                <button class="btn btn-sm btn-info px-2 py-1" title="Mark Completed" onclick="markComplaintComplete('${complaint.id}')">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-sm btn-success px-2 py-1" title="Find Personnel" onclick="findAndShowPersonnel('${complaint.id}')">
                                  <i class="fas fa-user-cog"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update complaint statistics display
        function updateComplaintStatistics(complaints) {
            // Calculate statistics
            const total = complaints.length;
            const pending = complaints.filter(c => c.status === 'pending').length;
            const inProgress = complaints.filter(c => c.status === 'in_progress' || c.status === 'assigned').length;
            const completed = complaints.filter(c => c.status === 'completed').length;
            
            // Update UI
            document.getElementById('total-complaints').textContent = total;
            document.getElementById('pending-complaints').textContent = pending;
            document.getElementById('in-progress-complaints').textContent = inProgress;
            document.getElementById('completed-complaints').textContent = completed;
        }

        // View complaint details
        async function viewComplaintDetails(complaintId) {
            try {
                const complaints = await fetchComplaintsFromFirestore();
                let complaint = complaints.find(c => c.id === complaintId);
                if (!complaint) {
                    console.warn('Complaint not found for id:', complaintId, 'Falling back to first valid complaint.');
                    complaint = complaints.find(c => c.description); // fallback to first valid
                    if (!complaint) {
                    showToast('Complaint not found', 'error');
                    return;
                }
                }
                window.currentComplaint = complaint;
                // Populate modal fields robustly
                document.getElementById('detail-complaint-id').textContent = complaint.id || '-';
                document.getElementById('detail-tenant').textContent = complaint.tenantId || '-';
                document.getElementById('detail-date').textContent = complaint.createdAt ? new Date(complaint.createdAt).toLocaleString() : '-';
                const statusBadge = document.getElementById('detail-status');
                statusBadge.textContent = getStatusLabel(complaint.status);
                statusBadge.className = `badge ${getStatusBadgeClass(complaint.status)}`;
                document.getElementById('detail-category').textContent = complaint.categoryLabel || getCategoryLabel(complaint.category) || '-';
                document.getElementById('detail-location').textContent = complaint.location || '-';
                const urgencyBadge = document.getElementById('detail-urgency');
                urgencyBadge.textContent = complaint.urgencyLabel || complaint.urgency || '-';
                urgencyBadge.className = `badge ${getUrgencyBadgeClass(complaint.urgency)}`;
                document.getElementById('detail-description').textContent = complaint.description || '-';
                document.getElementById('detail-notes').textContent = complaint.notes || '-';
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('complaintDetailModal'));
                modal.show();
            } catch (error) {
                showToast('Failed to load complaint details', 'error');
            }
        }

        // Update complaint status
        async function updateComplaintStatus() {
            if (!currentComplaint) return;
            
            const newStatus = document.getElementById('update-status').value;
            
            try {
                await complaintManager.updateComplaintStatus(currentComplaint.id, newStatus);
                
                // Reload complaints
                loadComplaints();
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('complaintDetailModal')).hide();
                
                showToast(`Complaint status updated to ${getStatusLabel(newStatus)}`);
            } catch (error) {
                console.error('Error updating complaint status:', error);
                showToast('Failed to update complaint status', 'error');
            }
        }

        // Add notes to complaint
        async function addComplaintNotes() {
            if (!currentComplaint) return;
            
            const notes = document.getElementById('update-notes').value.trim();
            
            if (!notes) {
                showToast('Please enter notes', 'warning');
                return;
            }
            
            try {
                // Combine existing notes with new notes
                const updatedNotes = currentComplaint.notes 
                    ? `${currentComplaint.notes}\n\n${new Date().toLocaleString()}: ${notes}`
                    : `${new Date().toLocaleString()}: ${notes}`;
                
                await complaintManager.updateComplaintStatus(
                    currentComplaint.id, 
                    currentComplaint.status, 
                    updatedNotes
                );
                
                // Update the modal view
                document.getElementById('detail-notes').textContent = updatedNotes;
                
                // Clear notes field
                document.getElementById('update-notes').value = '';
                
                // Update current complaint object
                currentComplaint.notes = updatedNotes;
                
                showToast('Notes added successfully');
            } catch (error) {
                console.error('Error adding notes:', error);
                showToast('Failed to add notes', 'error');
            }
        }

        // Populate maintenance personnel dropdown
        async function populatePersonnelDropdown(category) {
            try {
                const personnel = await complaintManager.getMaintenancePersonnel(category);
                const personnelSelect = document.getElementById('assign-personnel');
                
                if (!personnel) {
                    personnelSelect.innerHTML = '<option value="">No personnel available</option>';
                    return;
                }
                
                // Add main personnel for this category
                personnelSelect.innerHTML = `<option value="${personnel.name}">${personnel.name} - ${personnel.category}</option>`;
                
                // Fetch all categories to get other personnel
                const categories = await complaintManager.getFallbackCategories();
                
                // Add other personnel options
                for (const cat of Object.keys(categories)) {
                    if (cat !== category) {
                        const otherPersonnel = await complaintManager.getMaintenancePersonnel(cat);
                        personnelSelect.innerHTML += `<option value="${otherPersonnel.name}">${otherPersonnel.name} - ${otherPersonnel.category}</option>`;
                    }
                }
            } catch (error) {
                console.error('Error populating personnel dropdown:', error);
            }
        }

        // Assign maintenance personnel to complaint
        async function assignMaintenancePersonnel() {
            if (!currentComplaint) return;
            
            const personnelName = document.getElementById('assign-personnel').value;
            
            if (!personnelName) {
                showToast('Please select a maintenance personnel', 'warning');
                return;
            }
            
            try {
                // Get personnel details
                const category = currentComplaint.category || 'general';
                const personnel = await complaintManager.getMaintenancePersonnel(category);
                
                // Assign personnel to complaint
                await complaintManager.assignMaintenance(currentComplaint.id, personnel);
                
                // Update current complaint
                currentComplaint.assignedTo = personnel;
                currentComplaint.status = 'assigned';
                
                // Update the modal view
                const assignedInfo = document.getElementById('detail-assigned-info');
                assignedInfo.innerHTML = `
                    <div class="d-flex align-items-center mb-2">
                        <div class="avatar-sm me-3 bg-info text-white rounded-circle d-flex align-items-center justify-content-center">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <h6 class="mb-0">${personnel.name}</h6>
                            <small>${personnel.category}</small>
                        </div>
                    </div>
                    <div class="d-flex gap-3 mt-2">
                        <div><i class="fas fa-phone me-1"></i> ${personnel.phone}</div>
                        <div><i class="fas fa-envelope me-1"></i> ${personnel.email}</div>
                    </div>
                `;
                
                // Update status in modal
                const statusBadge = document.getElementById('detail-status');
                statusBadge.textContent = getStatusLabel('assigned');
                statusBadge.className = `badge ${getStatusBadgeClass('assigned')}`;
                
                // Update status dropdown
                document.getElementById('update-status').value = 'assigned';
                
                // Reload complaints
                loadComplaints();
                
                showToast(`Assigned ${personnel.name} to this complaint`);
            } catch (error) {
                console.error('Error assigning personnel:', error);
                showToast('Failed to assign personnel', 'error');
            }
        }

        // Quick actions for complaint status changes
        async function markComplaintInProgress(complaintId) {
            try {
                await complaintManager.updateComplaintStatus(complaintId, 'in_progress');
                loadComplaints();
                showToast('Complaint marked as in progress');
            } catch (error) {
                console.error('Error updating complaint status:', error);
                showToast('Failed to update complaint status', 'error');
            }
        }

        async function markComplaintComplete(complaintId) {
            try {
                await complaintManager.updateComplaintStatus(complaintId, 'completed');
                loadComplaints();
                showToast('Complaint marked as completed');
            } catch (error) {
                console.error('Error updating complaint status:', error);
                showToast('Failed to update complaint status', 'error');
            }
        }

        // Helper functions for complaint display
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'pending': return 'bg-warning';
                case 'assigned': return 'bg-info';
                case 'in_progress': return 'bg-primary';
                case 'completed': return 'bg-success';
                case 'cancelled': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        function getStatusLabel(status) {
            switch (status) {
                case 'pending': return 'Pending';
                case 'assigned': return 'Assigned';
                case 'in_progress': return 'In Progress';
                case 'completed': return 'Completed';
                case 'cancelled': return 'Cancelled';
                default: return status.charAt(0).toUpperCase() + status.slice(1);
            }
        }

        function getUrgencyBadgeClass(urgency) {
            switch(urgency) {
                case 'High': return 'bg-danger';
                case 'Medium': return 'bg-warning';
                case 'Low': return 'bg-info';
                default: return 'bg-secondary';
            }
        }

        function getCategoryLabel(category) {
            switch(category) {
                case 'electrical': return 'Electrical';
                case 'plumbing': return 'Plumbing';
                case 'structural': return 'Structural';
                case 'hvac': return 'HVAC';
                case 'pest_control': return 'Pest Control';
                case 'security': return 'Security';
                case 'appliance': return 'Appliance';
                case 'common_area': return 'Common Area';
                case 'noise_complaint': return 'Noise Complaint';
                default: return category ? category.charAt(0).toUpperCase() + category.slice(1) : 'Uncategorized';
            }
        }

        // Initialize the complaints section
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded - initializing complaints section');
            
            // Initialize the database
            dbManager.initialize().then(() => {
                console.log('Database initialized successfully');
                // Add manual debug button to top of complaints section
                const complaintHeader = document.querySelector('#complaintsSection .d-flex.justify-content-between');
                if (complaintHeader) {
                    const debugBtn = document.createElement('button');
                    debugBtn.className = 'btn btn-outline-secondary ms-2';
                    debugBtn.innerHTML = '<i class="fas fa-sync"></i> Reload Complaints';
                    debugBtn.addEventListener('click', function() {
                        loadComplaints();
                    });
                    complaintHeader.querySelector('.d-flex.gap-2').appendChild(debugBtn);
                }
            }).catch(error => {
                console.error('Error initializing database:', error);
                showToast('Error initializing database. Some features may not work correctly.', 'error');
            });
            
            // Load complaints when the section is shown
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.addEventListener('click', function() {
                    if (this.getAttribute('onclick') && this.getAttribute('onclick').includes('complaints')) {
                        console.log('Complaints section clicked, loading complaints...');
                        setTimeout(() => loadComplaints(), 500); // Load after section transition
                    }
                });
            });
        });
    </script>
    
    <!-- Firebase and Sync Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js"></script>
    

    
    <!-- Immediate Firebase Initialization -->
    <script>
        // Force initialize Firebase immediately
        (function() {
            try {
                if (!window.firebase) {
                    console.error('[CRITICAL] Firebase SDK not available on window object!');
                    return;
                }
                
                console.log('[Critical Fix] Attempting to initialize Firebase directly on page load');
                
                if (!window.firebase.apps || window.firebase.apps.length === 0) {
                    const firebaseConfig = {
                        apiKey: "AIzaSyBHfCZvWwZfCwG3OZW4HK7rwEJCOGk34AM",
                        authDomain: "wwa1-75695.firebaseapp.com",
                        projectId: "wwa1-75695",
                        storageBucket: "wwa1-75695.firebasestorage.app",
                        messagingSenderId: "891647347229",
                        appId: "1:891647347229:web:860e163df10594dba394f4",
                        measurementId: "G-D5LM21D4E4"
                    };
                    
                    window.firebase.initializeApp(firebaseConfig);
                    
                    // Explicitly create and attach the Firestore instance to window
                    if (window.firebase.firestore) {
                        window.firestoreDB = window.firebase.firestore();
                        console.log('[Critical Fix] Firestore initialized and attached to window.firestoreDB');
                    }
                    
                    console.log('[Critical Fix] Firebase successfully initialized!');
                } else {
                    console.log('[Critical Fix] Firebase already initialized.');
                }
            } catch (error) {
                console.error('[Critical Fix] Failed to initialize Firebase:', error);
            }
        })();
    </script>
    
    <!-- Direct Firebase Initialization -->
    <script>
        // Initialize Firebase immediately
        (function() {
            try {
                if (window.firebase) {
                    console.log('[DirectInit] Firebase SDK found, checking if app is initialized');
                    
                    // Check if already initialized
                    if (window.firebase.apps && window.firebase.apps.length > 0) {
                        console.log('[DirectInit] Firebase app already initialized');
                    } else {
                        // Initialize Firebase
                        console.log('[DirectInit] Initializing Firebase app');
                        const firebaseConfig = {
                            apiKey: "AIzaSyBHfCZvWwZfCwG3OZW4HK7rwEJCOGk34AM",
                            authDomain: "wwa1-75695.firebaseapp.com",
                            projectId: "wwa1-75695",
                            storageBucket: "wwa1-75695.firebasestorage.app",
                            messagingSenderId: "891647347229",
                            appId: "1:891647347229:web:860e163df10594dba394f4",
                            measurementId: "G-D5LM21D4E4"
                        };
                        
                        window.firebase.initializeApp(firebaseConfig);
                        console.log('[DirectInit] Firebase app initialized successfully');
                    }
                } else {
                    console.error('[DirectInit] Firebase SDK not found on window. Check script loading order.');
                }
            } catch (error) {
                console.error('[DirectInit] Error initializing Firebase:', error);
            }
        })();
    </script>
    
    <script src="js/auth-helper.js"></script>
    <script type="module" src="js/init-sync.js"></script>
    <script type="module">
        import { initializeFirestore } from './js/init-firestore.js';
        
        // Make initializeFirestore available globally
        window.initializeFirestore = initializeFirestore;
    </script>
    

    <script>
      if (!window.listingDB && window.ListingDB) {
        window.listingDB = new window.ListingDB();
        console.log('listingDB was not defined, created new instance at end of body.');
      }
    </script>
    <script>
      if (!window.paymentHistoryDB && window.PaymentHistoryDB) {
        window.paymentHistoryDB = new window.PaymentHistoryDB();
        console.log('paymentHistoryDB was not defined, created new instance at end of body.');
      }
    </script>


    <script>
    // Ensure ComplaintManager is available globally after dbManager is ready
    if (typeof ComplaintManager === 'undefined' && window.ComplaintManager) {
      // Already loaded by script
    }
    
    function setupComplaintManager() {
      if (window.dbManager && window.ComplaintManager) {
        window.complaintManager = new window.ComplaintManager(window.dbManager);
        console.log('ComplaintManager initialized and set globally.');
      } else {
        setTimeout(setupComplaintManager, 500);
      }
    }
    // Run after DOMContentLoaded and after dbManager is ready
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      setupComplaintManager();
    } else {
      document.addEventListener('DOMContentLoaded', setupComplaintManager);
    }
    </script>

    <script>
    // Wait for dbManager compatibility layer to be ready before running dashboard logic
    function waitForDbManagerReady(cb) {
      if (window.dbManager && typeof window.dbManager.getComplaints === 'function') {
        cb();
      } else {
        setTimeout(() => waitForDbManagerReady(cb), 200);
      }
    }
    
    // Move all dashboard initialization logic that depends on dbManager inside this callback
    waitForDbManagerReady(() => {
      // Ensure ComplaintManager is available globally after dbManager is ready
      if (window.ComplaintManager && !window.complaintManager) {
        window.complaintManager = new window.ComplaintManager(window.dbManager);
        console.log('ComplaintManager initialized and set globally.');
      }
      // If you have other dashboard initialization code (e.g., event listeners, DOMContentLoaded logic),
      // move it here or call it from here to ensure dbManager is ready first.
      // Example: if you have a function like initializeDashboard(), call it here.
      if (typeof initializeDashboard === 'function') {
        initializeDashboard();
      }
    });
    </script>
    
    <script>
    // ============ FIRESTORE-NATIVE COMPLAINTS SECTION ============
    
    // Helper: build Firestore query with filters
    async function fetchComplaintsFromFirestore(filters = {}) {
      let query = firebase.firestore().collection('complaints');
      if (filters.status) query = query.where('status', '==', filters.status);
      if (filters.category) query = query.where('category', '==', filters.category);
      if (filters.urgency) query = query.where('urgency', '==', filters.urgency);
      if (filters.tenantId) query = query.where('tenantId', '==', filters.tenantId);
      // Firestore can't do range+multiple where, so filter date/searchText in JS
      const snapshot = await query.get();
      let complaints = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      if (filters.startDate) {
        const start = new Date(filters.startDate);
        complaints = complaints.filter(c => new Date(c.createdAt) >= start);
      }
      if (filters.endDate) {
        const end = new Date(filters.endDate);
        complaints = complaints.filter(c => new Date(c.createdAt) <= end);
      }
      if (filters.searchText) {
        const s = filters.searchText.toLowerCase();
        complaints = complaints.filter(c =>
          (c.description && c.description.toLowerCase().includes(s)) ||
          (c.tenantId && c.tenantId.toLowerCase().includes(s))
        );
      }
      return complaints;
    }
    
    // Fetch and render complaints for the admin dashboard
    async function loadComplaints() {
      try {
        console.log('Loading complaints from Firestore...');
        document.getElementById('complaintsList').innerHTML = `<tr><td colspan="8" class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2 text-muted">Loading complaints...</p></td></tr>`;
        // Get filters from UI
        const filters = {
          status: document.getElementById('complaint-status-filter')?.value,
          category: document.getElementById('complaint-category-filter')?.value,
          urgency: document.getElementById('complaint-urgency-filter')?.value,
          searchText: document.getElementById('complaint-search-filter')?.value,
          startDate: document.getElementById('complaint-date-from')?.value,
          endDate: document.getElementById('complaint-date-to')?.value
        };
        // Remove empty filters
        Object.keys(filters).forEach(k => { if (!filters[k]) delete filters[k]; });
        const complaints = await fetchComplaintsFromFirestore(filters);
        updateComplaintStatistics(complaints);
        renderComplaintsTable(complaints);
        if (complaintView === 'dashboard') renderComplaintAnalytics(complaints);
      } catch (error) {
        console.error('Error loading complaints from Firestore:', error);
        showToast('Failed to load complaints: ' + (error.message || 'Unknown error'), 'error');
        document.getElementById('complaintsList').innerHTML = `<tr><td colspan="8" class="text-center py-4 text-danger"><i class="fas fa-exclamation-circle me-2"></i>Error loading complaints. Please try again.</td></tr>`;
      }
    }
    
    // Update statistics display
    function updateComplaintStatistics(complaints) {
      document.getElementById('total-complaints').textContent = complaints.length;
      document.getElementById('pending-complaints').textContent = complaints.filter(c => c.status === 'pending').length;
      document.getElementById('in-progress-complaints').textContent = complaints.filter(c => c.status === 'in_progress' || c.status === 'assigned').length;
      document.getElementById('completed-complaints').textContent = complaints.filter(c => c.status === 'completed').length;
    }
    
    // Render complaints table (reuse your existing renderComplaintsTable function, but remove complaintManager dependency)
    // ... existing renderComplaintsTable function ...
    
    // Filter complaints (calls loadComplaints)
    function filterComplaints() { loadComplaints(); }
    function resetComplaintFilters() {
      document.getElementById('complaint-status-filter').value = '';
      document.getElementById('complaint-category-filter').value = '';
      document.getElementById('complaint-urgency-filter').value = '';
      document.getElementById('complaint-search-filter').value = '';
      document.getElementById('complaint-date-from').value = '';
      document.getElementById('complaint-date-to').value = '';
      loadComplaints();
    }
    
    // Update complaint status in Firestore
    async function updateComplaintStatus() {
      if (!window.currentComplaint) return;
      const newStatus = document.getElementById('update-status').value;
      try {
        await firebase.firestore().collection('complaints').doc(window.currentComplaint.id).update({ status: newStatus, updatedAt: new Date().toISOString() });
        loadComplaints();
        bootstrap.Modal.getInstance(document.getElementById('complaintDetailModal')).hide();
        showToast(`Complaint status updated to ${getStatusLabel(newStatus)}`);
      } catch (error) {
        console.error('Error updating complaint status:', error);
        showToast('Failed to update complaint status', 'error');
      }
    }
    
    // Add notes to complaint in Firestore
    async function addComplaintNotes() {
      if (!window.currentComplaint) return;
      const notes = document.getElementById('update-notes').value.trim();
      if (!notes) { showToast('Please enter notes', 'warning'); return; }
      try {
        const updatedNotes = (window.currentComplaint.notes ? window.currentComplaint.notes + '\n\n' : '') + `${new Date().toLocaleString()}: ${notes}`;
        await firebase.firestore().collection('complaints').doc(window.currentComplaint.id).update({ notes: updatedNotes, updatedAt: new Date().toISOString() });
        document.getElementById('detail-notes').textContent = updatedNotes;
        document.getElementById('update-notes').value = '';
        window.currentComplaint.notes = updatedNotes;
        showToast('Notes added successfully');
      } catch (error) {
        console.error('Error adding notes:', error);
        showToast('Failed to add notes', 'error');
      }
    }
    
    // View complaint details (fetches from already loaded list)
    async function viewComplaintDetails(complaintId) {
      try {
        // Use the last loaded complaints list
        const complaints = await fetchComplaintsFromFirestore();
        window.currentComplaint = complaints.find(c => c.id === complaintId);
        if (!window.currentComplaint) { showToast('Complaint not found', 'error'); return; }
        // ... populate modal fields as before ...
        // (reuse your existing modal population code, but use window.currentComplaint)
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('complaintDetailModal'));
        modal.show();
      } catch (error) {
        showToast('Failed to load complaint details', 'error');
      }
    }
    
    // Assign maintenance personnel (update assignedTo in Firestore)
    async function assignMaintenancePersonnel() {
      if (!window.currentComplaint) return;
      const personnelName = document.getElementById('assign-personnel').value;
      if (!personnelName) { showToast('Please select a maintenance personnel', 'warning'); return; }
      try {
        // For demo, just assign the name (extend as needed)
        await firebase.firestore().collection('complaints').doc(window.currentComplaint.id).update({ assignedTo: { name: personnelName }, status: 'assigned', updatedAt: new Date().toISOString() });
        loadComplaints();
        showToast(`Assigned ${personnelName} to this complaint`);
      } catch (error) {
        showToast('Failed to assign personnel', 'error');
      }
    }
    
    // Mark complaint in progress/completed
    async function markComplaintInProgress(complaintId) {
      try {
        await firebase.firestore().collection('complaints').doc(complaintId).update({ status: 'in_progress', updatedAt: new Date().toISOString() });
        loadComplaints();
        showToast('Complaint marked as in progress');
      } catch (error) {
        showToast('Failed to update complaint status', 'error');
      }
    }
    async function markComplaintComplete(complaintId) {
      try {
        await firebase.firestore().collection('complaints').doc(complaintId).update({ status: 'completed', updatedAt: new Date().toISOString() });
        loadComplaints();
        showToast('Complaint marked as completed');
      } catch (error) {
        showToast('Failed to update complaint status', 'error');
      }
    }
    
    // On section show, auto-load complaints
    // (replace any complaintManager/dbManager logic with loadComplaints)
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.sidebar .nav-link').forEach(link => {
        link.addEventListener('click', function() {
          if (this.getAttribute('onclick') && this.getAttribute('onclick').includes('complaints')) {
            setTimeout(() => loadComplaints(), 500);
          }
        });
      });
    });
    
    // Add a new, clean modal for complaint details (read-only)
    if (!document.getElementById('complaintViewModal')) {
      const modalHtml = `
      <div class="modal fade" id="complaintViewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title"><i class="fas fa-eye me-2"></i>Complaint Details</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <dl class="row mb-0">
                <dt class="col-sm-4">Complaint ID</dt>
                <dd class="col-sm-8" id="view-complaint-id">-</dd>
                <dt class="col-sm-4">Tenant</dt>
                <dd class="col-sm-8" id="view-tenant">-</dd>
                <dt class="col-sm-4">Date Submitted</dt>
                <dd class="col-sm-8" id="view-date">-</dd>
                <dt class="col-sm-4">Status</dt>
                <dd class="col-sm-8"><span class="badge" id="view-status">-</span></dd>
                <dt class="col-sm-4">Category</dt>
                <dd class="col-sm-8" id="view-category">-</dd>
                <dt class="col-sm-4">Location</dt>
                <dd class="col-sm-8" id="view-location">-</dd>
                <dt class="col-sm-4">Urgency</dt>
                <dd class="col-sm-8"><span class="badge" id="view-urgency">-</span></dd>
                <dt class="col-sm-4">Description</dt>
                <dd class="col-sm-8" id="view-description">-</dd>
                <dt class="col-sm-4">Notes</dt>
                <dd class="col-sm-8" id="view-notes">-</dd>
                <dt class="col-sm-4">Assigned To</dt>
                <dd class="col-sm-8" id="view-assigned">-</dd>
                <dt class="col-sm-4">Photo</dt>
                <dd class="col-sm-8" id="view-photo">-</dd>
              </dl>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>`;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    // Implement showComplaintDetails(complaintId)
    window.showComplaintDetails = async function(complaintId) {
      try {
        const complaints = await fetchComplaintsFromFirestore();
        const complaint = complaints.find(c => c.id === complaintId);
        if (!complaint) {
          showToast('Complaint not found', 'error');
          return;
        }
        document.getElementById('view-complaint-id').textContent = complaint.id || '-';
        document.getElementById('view-tenant').textContent = complaint.tenantId || '-';
        document.getElementById('view-date').textContent = complaint.createdAt ? new Date(complaint.createdAt).toLocaleString() : '-';
        const statusBadge = document.getElementById('view-status');
        statusBadge.textContent = getStatusLabel(complaint.status);
        statusBadge.className = `badge ${getStatusBadgeClass(complaint.status)}`;
        document.getElementById('view-category').textContent = complaint.categoryLabel || getCategoryLabel(complaint.category) || '-';
        document.getElementById('view-location').textContent = complaint.location || '-';
        const urgencyBadge = document.getElementById('view-urgency');
        urgencyBadge.textContent = complaint.urgencyLabel || complaint.urgency || '-';
        urgencyBadge.className = `badge ${getUrgencyBadgeClass(complaint.urgency)}`;
        document.getElementById('view-description').textContent = complaint.description || '-';
        document.getElementById('view-notes').textContent = complaint.notes || '-';
        document.getElementById('view-assigned').textContent = (complaint.assignedTo && complaint.assignedTo.name) ? complaint.assignedTo.name : '-';
        // Show photo if available
        const photoCell = document.getElementById('view-photo');
        if (complaint.photoUrl) {
          photoCell.innerHTML = `<img src="${complaint.photoUrl}" alt="Complaint Photo" style="max-width: 100%; max-height: 200px;">`;
        } else {
          photoCell.textContent = '-';
        }
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('complaintViewModal'));
        modal.show();
      } catch (error) {
        showToast('Failed to load complaint details', 'error');
      }
    };
    
    // 1. Add Register Personnel button below complaints table
    const complaintsSection = document.getElementById('complaintsSection');
    if (complaintsSection && !document.getElementById('registerPersonnelBtn')) {
      const btnHtml = `<div class="my-4 text-end"><button id="registerPersonnelBtn" class="btn btn-success"><i class="fas fa-user-plus me-2"></i>Register Personnel</button></div>`;
      const complaintsTable = document.getElementById('complaint-table-view');
      if (complaintsTable) complaintsTable.insertAdjacentHTML('afterend', btnHtml);
    }
    
    // 2. Add Personnel Modal (for add/edit)
    if (!document.getElementById('personnelModal')) {
      const modalHtml = `
      <div class="modal fade" id="personnelModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="personnelModalTitle"><i class="fas fa-user-plus me-2"></i>Register Personnel</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <form id="personnelForm">
                <input type="hidden" id="personnelId">
                <div class="mb-3">
                  <label class="form-label">Name</label>
                  <input type="text" class="form-control" id="personnelName" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Phone</label>
                  <input type="tel" class="form-control" id="personnelPhone" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Email</label>
                  <input type="email" class="form-control" id="personnelEmail">
                </div>
                <div class="mb-3">
                  <label class="form-label">Specialization/Category</label>
                  <select class="form-select" id="personnelCategory" required>
                    <option value="">Select Category</option>
                    <option value="electrical">Electrical</option>
                    <option value="plumbing">Plumbing</option>
                    <option value="structural">Structural</option>
                    <option value="hvac">Air Conditioning/Heating</option>
                    <option value="pest_control">Pest Control</option>
                    <option value="security">Security</option>
                    <option value="appliance">Appliance</option>
                    <option value="common_area">Common Area</option>
                    <option value="housekeeping">Housekeeping/Cleaning</option>
                    <option value="system">System/IT Support</option>
                    <option value="noise">Noise/Disturbance</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Notes</label>
                  <textarea class="form-control" id="personnelNotes" rows="2"></textarea>
                </div>
                <div class="text-end">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-success">Save</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>`;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    // 3. Add Personnel Table below Register button
    if (!document.getElementById('personnelTableCard')) {
      const tableHtml = `
      <div class="card my-4" id="personnelTableCard">
        <div class="card-header bg-white"><h5 class="mb-0"><i class="fas fa-users-cog me-2"></i>Registered Maintenance Personnel</h5></div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="bg-light">
                <tr>
                  <th>Name</th>
                  <th>Phone</th>
                  <th>Email</th>
                  <th>Category</th>
                  <th>Notes</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="personnelList">
                <!-- Personnel will be loaded here -->
              </tbody>
            </table>
          </div>
              </div>
            </div>`;
      const btn = document.getElementById('registerPersonnelBtn');
      if (btn) btn.insertAdjacentHTML('afterend', tableHtml);
    }
    
    // 4. JS: Load, Add, Edit Personnel
    window.loadPersonnel = async function() {
      try {
        const snapshot = await firebase.firestore().collection('personnel').get();
        const personnel = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        const list = document.getElementById('personnelList');
        if (!list) return;
        if (personnel.length === 0) {
          list.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-muted"><i class="fas fa-inbox me-2"></i>No personnel registered</td></tr>`;
          return;
        }
        list.innerHTML = personnel.map(p => `
          <tr>
            <td>${p.name || '-'}</td>
            <td>${p.phone || '-'}</td>
            <td>${p.email || '-'}</td>
            <td>${getCategoryLabel(p.category) || '-'}</td>
            <td>${p.notes || '-'}</td>
            <td>
              <div class="d-flex gap-1">
                <button class="btn btn-sm btn-primary" title="Edit" onclick="editPersonnel('${p.id}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-danger" title="Delete" onclick="deletePersonnel('${p.id}', '${p.name || ''}')"><i class="fas fa-trash"></i></button>
              </div>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        showToast('Failed to load personnel', 'error');
      }
    };
    
    window.addEventListener('DOMContentLoaded', () => loadPersonnel());
    
    // Register button opens modal
    const regBtn = document.getElementById('registerPersonnelBtn');
    if (regBtn) regBtn.onclick = () => {
      document.getElementById('personnelModalTitle').textContent = 'Register Personnel';
      document.getElementById('personnelForm').reset();
      document.getElementById('personnelId').value = '';
      new bootstrap.Modal(document.getElementById('personnelModal')).show();
    };
    
    // Save personnel (add or edit)
    document.getElementById('personnelForm').onsubmit = async function(e) {
      e.preventDefault();
      const id = document.getElementById('personnelId').value;
      const data = {
        name: document.getElementById('personnelName').value.trim(),
        phone: document.getElementById('personnelPhone').value.trim(),
        email: document.getElementById('personnelEmail').value.trim(),
        category: document.getElementById('personnelCategory').value,
        notes: document.getElementById('personnelNotes').value.trim(),
        updatedAt: new Date().toISOString()
      };
      try {
        if (id) {
          await firebase.firestore().collection('personnel').doc(id).update(data);
          showToast('Personnel updated successfully');
        } else {
          data.createdAt = new Date().toISOString();
          await firebase.firestore().collection('personnel').add(data);
          showToast('Personnel registered successfully');
        }
        bootstrap.Modal.getInstance(document.getElementById('personnelModal')).hide();
        loadPersonnel();
      } catch (error) {
        showToast('Failed to save personnel', 'error');
      }
    };
    
    // Edit personnel
    window.editPersonnel = async function(id) {
      try {
        const doc = await firebase.firestore().collection('personnel').doc(id).get();
        if (!doc.exists) { showToast('Personnel not found', 'error'); return; }
        const p = doc.data();
        document.getElementById('personnelModalTitle').textContent = 'Edit Personnel';
        document.getElementById('personnelId').value = id;
        document.getElementById('personnelName').value = p.name || '';
        document.getElementById('personnelPhone').value = p.phone || '';
        document.getElementById('personnelEmail').value = p.email || '';
        document.getElementById('personnelCategory').value = p.category || '';
        document.getElementById('personnelNotes').value = p.notes || '';
        new bootstrap.Modal(document.getElementById('personnelModal')).show();
      } catch (error) {
        showToast('Failed to load personnel', 'error');
      }
    };
    // ... existing code ...
    
    // Delete personnel
    window.deletePersonnel = async function(id, name) {
      if (!confirm(`Are you sure you want to delete ${name || 'this personnel'}? This action cannot be undone.`)) return;
      try {
        await firebase.firestore().collection('personnel').doc(id).delete();
        showToast('Personnel deleted successfully');
        loadPersonnel();
      } catch (error) {
        showToast('Failed to delete personnel', 'error');
      }
    };
    // ... existing code ...
    
    // Modal UI/UX adjustments for uniformity
    const personnelModal = document.getElementById('personnelModal');
    if (personnelModal) {
      personnelModal.querySelector('.modal-header').classList.add('bg-light', 'border-bottom');
      personnelModal.querySelector('.modal-title').classList.add('fw-bold');
      personnelModal.querySelector('.btn-close').classList.add('ms-auto');
      const saveBtn = personnelModal.querySelector('button[type="submit"]');
      if (saveBtn) saveBtn.classList.remove('btn-success');
      if (saveBtn) saveBtn.classList.add('btn-primary');
      const cancelBtn = personnelModal.querySelector('button.btn-secondary');
      if (cancelBtn) cancelBtn.classList.add('me-2');
    }
    // ... existing code ...
    
    // Update personnel table markup for uniformity
    const personnelTableCard = document.getElementById('personnelTableCard');
    if (personnelTableCard) {
      personnelTableCard.className = 'card my-4 shadow-sm';
      const cardHeader = personnelTableCard.querySelector('.card-header');
      if (cardHeader) {
        cardHeader.className = 'card-header bg-light border-bottom d-flex align-items-center';
        cardHeader.querySelector('h5').className = 'mb-0 fw-bold';
      }
      const cardBody = personnelTableCard.querySelector('.card-body');
      if (cardBody) cardBody.className = 'card-body p-0';
      const table = personnelTableCard.querySelector('table');
      if (table) {
        table.className = 'table table-hover align-middle mb-0';
        table.style.width = '100%';
      }
      const thead = personnelTableCard.querySelector('thead');
      if (thead) thead.className = 'bg-light';
      const tbody = personnelTableCard.querySelector('tbody');
      if (tbody) tbody.className = '';
    }
    // ... existing code ...
    </script>
    
    <script>
    // ... existing code ...
    let currentListingStatusFilter = 'all';
    
    function setupFilterButtons() {
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          currentListingStatusFilter = this.getAttribute('data-filter');
          await applyListingFilters();
        });
      });
    }
    
    document.getElementById('listingSearchBtn').addEventListener('click', applyListingFilters);
    document.getElementById('listingSearch').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') applyListingFilters();
    });
    
    async function applyListingFilters() {
      showLoading();
      try {
        let listings = [];
        if (currentListingStatusFilter === 'all') {
          listings = await listingDB.getAllListings();
          } else {
          listings = await listingDB.getListingsByStatus(currentListingStatusFilter);
        }
        const searchTerm = document.getElementById('listingSearch').value.trim().toLowerCase();
        if (searchTerm) {
          listings = listings.filter(listing =>
            (listing.title && listing.title.toLowerCase().includes(searchTerm)) ||
            (listing.location && listing.location.toLowerCase().includes(searchTerm)) ||
            (listing.description && listing.description.toLowerCase().includes(searchTerm)) ||
            (listing.type && listing.type.toLowerCase().includes(searchTerm))
          );
        }
        window.renderListings(listings);
        hideLoading();
      } catch (error) {
        console.error('Failed to filter/search listings:', error);
        showToast('Failed to filter/search listings', 'error');
        hideLoading();
      }
    }
    // ... existing code ...
    </script>

    <script>
    // ... existing code ...
    document.addEventListener('DOMContentLoaded', function() {
        const container = document.getElementById('listingImagesContainer');
        const addBtn = document.getElementById('addImageInputBtn');
        let imageInputCount = 1;
        addBtn.addEventListener('click', function() {
            imageInputCount++;
            const input = document.createElement('input');
            input.type = 'file';
            input.className = 'form-control mb-2';
            input.accept = 'image/*';
            input.name = 'listingImages' + imageInputCount;
            input.id = 'listingImages' + imageInputCount;
            container.appendChild(input);
        });
    });
    // ... existing code ...
    </script>
    
    <!-- Function to open the Add New Listing modal -->
    <script>
    function openAddListingModal() {
        // Reset all form fields
        document.getElementById('listingModalTitle').innerHTML = '<i class="fas fa-plus me-2"></i>Add New Listing';
        document.getElementById('listingId').value = '';
        document.getElementById('listingTitle').value = '';
        document.getElementById('listingType').value = '';
        document.getElementById('listingPrice').value = '';
        document.getElementById('listingStatus').value = 'available';
        document.getElementById('listingDescription').value = '';
        document.getElementById('listingArea').value = '';
        // Reset feature buttons
        document.querySelectorAll('.feature-btn').forEach(btn => btn.classList.remove('selected'));
        updateFeatureInput();
        setupFeatureButtons();
        // Reset images
        currentListingImages = [];
        const imgContainer = document.getElementById('listingImagesContainer');
        imgContainer.innerHTML = '';
        // Add a fresh file input (with multiple support)
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.className = 'form-control mb-2';
        fileInput.id = 'listingImages';
        fileInput.name = 'listingImages';
        fileInput.accept = 'image/*';
        fileInput.multiple = true;
        imgContainer.appendChild(fileInput);
        const modal = new bootstrap.Modal(document.getElementById('listingModal'));
        modal.show();
    }
    </script>
    
    <script>
    // ... existing code ...
    // Show/hide unit dropdown based on role
    const newRoleSelect = document.getElementById('newRole');
    const tenantUnitGroup = document.getElementById('tenantUnitGroup');
    newRoleSelect.addEventListener('change', async function() {
        if (this.value === 'tenant') {
            tenantUnitGroup.style.display = '';
            // Populate units
            const unitSelect = document.getElementById('tenantUnit');
            unitSelect.innerHTML = '<option value="">Loading...</option>';
            let listings = [];
            if (window.listingsManager && window.listingsManager.getAllListings) {
                listings = await window.listingsManager.getAllListings({ type: 'apartment', status: 'available' });
            } else if (window.listingDB && window.listingDB.getAllListings) {
                listings = await window.listingDB.getAllListings();
                listings = listings.filter(l => (l.type === 'apartment' || l.propertyType === 'apartment') && (l.status === 'available'));
            }
            unitSelect.innerHTML = '<option value="">Select Unit</option>';
            listings.forEach(listing => {
                const label = listing.title ? `${listing.title} (${listing.area || ''} sqm)` : listing.id;
                const option = document.createElement('option');
                option.value = listing.id;
                option.textContent = label;
                unitSelect.appendChild(option);
            });
        } else {
            tenantUnitGroup.style.display = 'none';
        }
    });
    // ... existing code ...
    async function createAccount(event) {
      event.preventDefault();
        const username = document.getElementById('newUsername').value;
        const email = document.getElementById('newEmail').value;
        const password = document.getElementById('newPassword').value;
        const role = document.getElementById('newRole').value;
        const status = document.getElementById('newStatus').value;
        // Photo upload
        const photoInput = document.getElementById('newPhoto');
        let photoUrl = '';
        if (photoInput && photoInput.files && photoInput.files.length > 0) {
            const file = photoInput.files[0];
            // Upload to Firebase Storage
            const storageRef = firebase.storage().ref();
            const fileName = `accounts/${Date.now()}_${file.name}`;
            const fileRef = storageRef.child(fileName);
            await fileRef.put(file);
            photoUrl = await fileRef.getDownloadURL();
        }
        // Unit assignment for tenants
        let unitId = '';
        if (role === 'tenant') {
            unitId = document.getElementById('tenantUnit').value;
        }
        const rfidRaw = document.getElementById('newRfid').value.trim();
        const rfid = rfidRaw.replace(/[^0-9]/g, '');
        // Duplicate RFID validation
        if (rfid) {
            const allAccounts = await dbManager.getAllAccounts();
            const duplicate = allAccounts.find(acc => acc.rfid && acc.rfid === rfid);
            if (duplicate) {
                showToast('RFID tag is already assigned to another account.', 'error');
                return;
            }
        }
        try {
            await dbManager.createAccount({
                username,
                email,
                password,
                role,
          status,
                photoUrl,
                unitId,
                rfid: rfid || undefined,
                createdAt: new Date().toISOString()
            });
            
            // Close modal and reset form
            const modal = bootstrap.Modal.getInstance(document.getElementById('createAccountModal'));
        modal.hide();
            document.getElementById('createAccountForm').reset();
            
            // Reload accounts
            loadAccounts();
            
            showToast('Account created successfully');
      } catch (error) {
            console.error('Failed to create account:', error);
            showToast(error.message || 'Failed to create account', 'error');
        }
    }
    // ... existing code ...
    </script>

    <div class="modal fade" id="profilePhotoModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="profilePhotoModalLabel">Profile Photo</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body text-center">
            <img id="profilePhotoModalImg" src="" alt="Profile Photo" style="max-width:100%;max-height:60vh;border-radius:12px;box-shadow:0 2px 16px #0002;">
            <div id="profilePhotoModalUsername" class="mt-3 fw-bold"></div>
          </div>
        </div>
      </div>
    </div>
    <script>
    function showProfilePhotoModal(url, username) {
      document.getElementById('profilePhotoModalImg').src = url;
      document.getElementById('profilePhotoModalUsername').textContent = username || '';
      const modal = new bootstrap.Modal(document.getElementById('profilePhotoModal'));
      modal.show();
    }
</script>

<script src="js/sidebar-mobile.js"></script>
<script src="js/account-cards-mobile.js"></script>
<script src="js/account-pagination.js"></script>
<script src="js/complaint-manager.js"></script>
<script src="js/complaint-pagination.js"></script>
<script src="js/booking-section.js"></script>
<script src="js/booking-pagination.js"></script>
<script src="js/listing-pagination.js"></script>

<script src="js/section-persistence.js"></script>

<script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.min.js"></script>

<!-- Add this at the end of the body -->
<div class="modal fade" id="findPersonnelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-user-cog me-2"></i>Assigned Personnel</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="findPersonnelModalBody">
        <!-- Populated by JS -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script src="js/find-personnel.js"></script>

</body>
</html> 